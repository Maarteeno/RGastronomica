<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Brain Buddy</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BrainBuddy">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#0f172a">

    <link rel="icon" id="favicon" href="">
    <link rel="apple-touch-icon" id="apple-icon" href="">

    <script>
        // TRUCO: Generar icono PNG al vuelo para iOS
        (function() {
            window.generateIcons = function() {
                var canvas = document.createElement('canvas');
                canvas.width = 180; canvas.height = 180;
                var ctx = canvas.getContext('2d');
                
                // Fondo
                ctx.fillStyle = '#1e1b4b'; 
                ctx.fillRect(0, 0, 180, 180);
                
                // Cerebro
                ctx.font = '100px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üß†', 90, 96); // Ajuste visual
                
                var url = canvas.toDataURL('image/png');
                document.getElementById('favicon').href = url;
                document.getElementById('apple-icon').href = url;
            };
        })();
    </script>

    <style>
        :root {
            /* Palette Dark Elegant */
            --bg-body: #0f172a; 
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 60%, #312e81 100%);
            
            --glass-bg: rgba(30, 41, 59, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            
            --primary: #6366f1;    /* Indigo */
            --secondary: #a855f7;  /* Purple */
            --accent: #38bdf8;     /* Sky */
            --highlight: #fbbf24;  /* Amber */
            
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            --success: #10b981;
            --danger: #f43f5e;
            
            --radius: 16px;
            --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --shadow: 0 10px 40px -10px rgba(0,0,0,0.6);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-main);
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            overscroll-behavior: none;
            user-select: none;
            -webkit-user-select: none;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* --- Header --- */
        .header {
            text-align: center;
            margin-bottom: 20px;
            margin-top: 10px;
            animation: fadeInDown 0.8s ease;
        }
        .header h1 { 
            font-size: 2.2rem; 
            background: linear-gradient(to right, #818cf8, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px; 
            font-weight: 800;
        }
        .header p { color: var(--text-muted); font-size: 0.9rem; letter-spacing: 1px; }

        /* --- Card Container --- */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            border: 1px solid var(--glass-border);
            position: relative;
            display: flex; flex-direction: column; align-items: center;
            flex: 1;
        }

        /* --- Buttons --- */
        .btn {
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: white;
            user-select: none;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .btn-outline { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-muted); padding: 8px 16px; font-size: 0.9rem; }
        .btn-outline:hover { background: rgba(255,255,255,0.1); color: white; border-color: var(--text-main); }
        .btn-restart { background: rgba(56, 189, 248, 0.15); color: var(--accent); border: 1px solid rgba(56, 189, 248, 0.3); padding: 8px; border-radius: 8px; }
        .btn-restart:active { background: rgba(56, 189, 248, 0.25); }

        /* --- Grid Menu --- */
        .game-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            width: 100%;
            padding-bottom: 40px;
        }
        .game-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            display: flex; flex-direction: column; justify-content: space-between;
            width: 46%;
            max-width: 150px;
            height: 140px; 
        }
        .game-card:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.08);
            border-color: var(--primary);
        }
        .game-icon { font-size: 2.2rem; margin-bottom: 8px; display: block; filter: drop-shadow(0 0 8px rgba(255,255,255,0.1)); }
        .game-title { font-size: 0.95rem; margin-bottom: 5px; color: var(--text-main); font-weight: 700; }
        .game-desc { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; line-height: 1.2; }

        /* --- Views --- */
        .view { display: none; animation: fadeIn 0.4s ease; width: 100%; height: 100%; }
        .view.active { display: block; }

        /* --- Game Controls --- */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
            width: 100%;
        }
        
        .controls-left, .controls-right { display: flex; gap: 10px; align-items: center; }

        .stats-bar {
            background: rgba(15, 23, 42, 0.6);
            padding: 6px 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.1rem;
            border: 1px solid var(--glass-border);
            color: var(--accent);
            min-width: 80px; text-align: center;
        }
        
        .time-bonus { animation: flashGreen 0.5s ease; color: var(--success) !important; }
        .time-penalty { animation: flashRed 0.5s ease; color: var(--danger) !important; }

        .difficulty-selector select {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: #1e293b;
            color: white;
            cursor: pointer;
            outline: none;
            font-size: 0.9rem;
        }

        #game-board-area {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 10px 0;
            flex: 1;
        }

        /* --- GAME STYLES --- */
        .memory-grid, .sudoku-grid, .schulte-grid, .matrix-grid, .chimp-grid, .eagle-grid, .hunt-grid, .slide-grid { display: grid; gap: 5px; margin: 0 auto; user-select: none; }
        
        /* Sliding Puzzle */
        .slide-grid { background: rgba(255,255,255,0.1); padding: 5px; border-radius: 12px; border: 1px solid var(--glass-border); }
        .slide-tile {
            aspect-ratio: 1;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
            transition: transform 0.2s;
            background-repeat: no-repeat;
        }
        .slide-tile:not(.empty):active { transform: scale(0.95); }
        .slide-tile.empty { background: transparent !important; box-shadow: none; cursor: default; }

        /* Equation Game */
        .eq-container { width: 100%; max-width: 400px; font-size: 1.3rem; display: flex; flex-direction: column; gap: 10px; }
        .eq-row { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px 15px; border-radius: 12px; font-weight: bold; }
        .eq-item { display: flex; gap: 10px; align-items: center; }
        
        /* Hunt Game */
        .hunt-cell { font-size: 1.8rem; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; display: flex; justify-content: center; align-items: center; aspect-ratio: 1; }
        .hunt-cell.found { background: var(--success); opacity: 0.5; pointer-events: none; transform: scale(0.9); }
        .hunt-cell:active { background: rgba(255,255,255,0.15); }
        
        /* Eagle Vision */
        .eagle-cell { background-color: var(--primary); border-radius: 6px; cursor: pointer; transition: transform 0.1s; border: none; }
        .eagle-cell:active { transform: scale(0.95); }
        
        /* Memory */
        .memory-card { width: 60px; height: 60px; position: relative; transform-style: preserve-3d; transition: transform 0.4s; cursor: pointer; }
        .memory-card.flip { transform: rotateY(180deg); }
        .front, .back { width: 100%; height: 100%; position: absolute; backface-visibility: hidden; border-radius: 10px; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 1px solid var(--glass-border); }
        .front { background: #1e293b; transform: rotateY(180deg); font-size: 1.8rem; }
        .back { background: linear-gradient(135deg, #334155, #475569); }

        /* Common Cells */
        .sudoku-cell, .schulte-cell, .matrix-cell, .chimp-cell { background: rgba(255,255,255,0.05); border-radius: 8px; display: flex; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; border: 1px solid var(--glass-border); transition: all 0.1s; }
        .sudoku-grid { grid-template-columns: repeat(9, 1fr); gap: 1px; background: #475569; border: 2px solid #475569; max-width: 400px; width: 100%; }
        .sudoku-cell { background: #1e293b; aspect-ratio: 1; font-size: 1.1rem; }
        .sudoku-cell:active, .schulte-cell:active, .matrix-cell:active { background: rgba(255,255,255,0.15); }

        .sudoku-cell.initial { color: var(--highlight); }
        .sudoku-cell.selected { background: rgba(99, 102, 241, 0.4); }
        .sudoku-cell.error { color: var(--danger); background: rgba(244, 63, 94, 0.2); }
        .numpad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 20px; max-width: 400px; width: 100%; }
        .numpad button { background: rgba(255,255,255,0.1); color: white; border: none; font-size: 1.1rem; padding: 10px; border-radius: 8px; cursor: pointer; }

        .schulte-cell { font-size: 1.5rem; aspect-ratio: 1; }
        .matrix-cell { aspect-ratio: 1; }
        .matrix-cell.active { background: var(--accent); box-shadow: 0 0 15px var(--accent); }
        .matrix-cell.ok { background: var(--success); }
        .matrix-cell.fail { background: var(--danger); }
        .chimp-cell { font-size: 1.8rem; color: white; aspect-ratio: 1; }
        .chimp-cell.covered { color: transparent; background: white; border-color: white; }
        .chimp-cell.hidden { opacity: 0; pointer-events: none; }

        /* Sorter */
        .sorter-container { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; }
        .sorter-card { width: 120px; height: 120px; background: #1e293b; border: 2px solid var(--accent); border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 3rem; font-weight: bold; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .sorter-controls { display: flex; gap: 20px; }
        .sorter-btn { width: 90px; height: 90px; border-radius: 50%; border: none; font-weight: bold; font-size: 0.9rem; color: white; cursor: pointer; transition: transform 0.1s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .sorter-btn:active { transform: scale(0.9); }
        .btn-left { background: var(--secondary); box-shadow: 0 8px 0 #7e22ce; }
        .btn-right { background: var(--success); box-shadow: 0 8px 0 #047857; }

        /* Stopwatch */
        .stopwatch-display { font-size: 4rem; font-family: 'Courier New', monospace; font-weight: bold; color: var(--accent); text-shadow: 0 0 20px rgba(56, 189, 248, 0.3); margin: 20px 0; }
        .stopwatch-target { font-size: 1.3rem; color: var(--text-muted); margin-bottom: 20px; }
        .stopwatch-btn { width: 120px; height: 120px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.1); background: var(--danger); color: white; font-size: 1.5rem; font-weight: bold; cursor: pointer; box-shadow: 0 0 30px rgba(244, 63, 94, 0.4); transition: all 0.2s; }
        .stopwatch-btn:active { transform: scale(0.95); background: #be123c; }
        .stopwatch-btn.running { background: #eab308; box-shadow: 0 0 30px rgba(234, 179, 8, 0.4); }

        /* Word Search & Stroop & Equation */
        .ws-grid { display: grid; gap: 2px; background: #334155; padding: 3px; border-radius: 8px; touch-action: none; }
        .ws-cell { background: #1e293b; width: 28px; height: 28px; display: flex; justify-content: center; align-items: center; font-weight: 600; cursor: pointer; font-size: 0.8rem; color: #cbd5e1; }
        .ws-cell.selected { background: var(--highlight); color: #0f172a; } .ws-cell.found { background: var(--success); color: #0f172a; }
        .stroop-word { font-size: 3rem; font-weight: 900; margin: 20px 0; text-shadow: 0 0 20px rgba(0,0,0,0.5); letter-spacing: 2px; }
        .choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .choice-btn { font-size: 1.3rem; padding: 15px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 12px; }
        .anagram-pool, .anagram-slots { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
        .letter-btn { width: 45px; height: 45px; border-radius: 8px; font-size: 1.5rem; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .diff-cell { background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 1.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; aspect-ratio: 1; }

        /* --- Modals --- */
        #confetti-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 1000; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal { background: #1e293b; padding: 30px; border-radius: 20px; max-width: 380px; width: 85%; text-align: center; border: 1px solid var(--glass-border); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal h2 { color: var(--primary); margin-bottom: 10px; font-size: 1.8rem; }
        .modal input { width: 100%; padding: 12px; margin: 10px 0 20px 0; border: 1px solid #334155; border-radius: 10px; font-size: 1.1rem; background: #0f172a; color: white; text-align: center; }
        #ranking-list { max-height: 350px; overflow-y: auto; text-align: left; }
        #ranking-list li { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; display: flex; justify-content: space-between; }
        #ranking-list b { color: var(--accent); }

        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes flashGreen { 0% { background: rgba(16, 185, 129, 0); } 50% { background: rgba(16, 185, 129, 0.3); } 100% { background: transparent; } }
        @keyframes flashRed { 0% { background: rgba(244, 63, 94, 0); } 50% { background: rgba(244, 63, 94, 0.3); } 100% { background: transparent; } }

        @media (max-width: 600px) {
            .header h1 { font-size: 2rem; }
            .game-grid { gap: 10px; }
            .stopwatch-display { font-size: 3.5rem; }
            .stopwatch-btn { width: 110px; height: 110px; }
        }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div class="container">
        <header class="header">
            <h1>üß† Brain Buddy</h1>
            <p>16 Juegos Mentales</p>
        </header>

        <div id="view-menu" class="view active">
            <div class="game-grid"></div>
            <div style="margin-top: 20px; text-align: center; width: 100%;">
                 <button class="btn btn-outline" onclick="App.showRankingGlobal()">üèÜ Ver R√©cords</button>
            </div>
        </div>

        <div id="view-game" class="view">
            <div class="card">
                <div class="game-header">
                    <div class="controls-left">
                        <button class="btn btn-outline" onclick="App.confirmExit()" onmousedown="App.confirmExit()">‚¨Ö Men√∫</button>
                        <div class="difficulty-selector">
                            <select id="difficulty-select" onchange="App.changeDifficulty(this.value)">
                                <option value="easy">F√°cil</option>
                                <option value="medium">Medio</option>
                                <option value="hard">Dif√≠cil</option>
                                <option value="extreme">Extremo</option>
                            </select>
                        </div>
                    </div>
                    <div class="controls-right">
                        <div class="stats-bar"><span id="stat-1">00:00</span></div>
                        <span id="stat-2" style="font-weight:bold; color:var(--highlight)"></span>
                        <button class="btn btn-restart" onclick="App.restartGame()" title="Reiniciar Juego">‚Üª</button>
                    </div>
                </div>
                
                <div id="game-title-display" style="text-align: center; margin-bottom: 10px; color: var(--primary); font-size: 1.3rem; font-weight: 700; letter-spacing: 1px;"></div>
                <div id="game-board-area"></div>
            </div>
        </div>
    </div>

    <div id="modal-win" class="modal-overlay">
        <div class="modal">
            <h2>üéâ Fin del Juego</h2>
            <p id="win-message">Resultados.</p>
            <div id="record-section" style="display:none; margin-top:15px;">
                <p style="color: var(--success); font-weight: bold; margin-bottom: 5px;">¬°NUEVO R√âCORD!</p>
                <input type="text" id="player-name" placeholder="Tu nombre..." maxlength="12" autocomplete="off">
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="App.handleWinAction('replay')">‚Üª Jugar</button>
                <button class="btn btn-outline" onclick="App.handleWinAction('exit')">‚ûú Salir</button>
            </div>
        </div>
    </div>

    <div id="modal-ranking" class="modal-overlay">
        <div class="modal">
            <h2>üèÜ R√©cords</h2>
            <div id="ranking-list"></div>
            <button class="btn btn-primary" style="margin-top:15px; width:100%" onclick="document.getElementById('modal-ranking').classList.remove('active')">Cerrar</button>
        </div>
    </div>

<script>
/** BRAIN BUDDY CORE v24 (iOS Icon Fix + Haptics) */
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

const Sound = {
    ctx: new (window.AudioContext || window.webkitAudioContext)(),
    play: function(freq, type, dur, vol=0.1) {
        if(this.ctx.state === 'suspended') this.ctx.resume();
        const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
        o.type = type; o.frequency.value = freq;
        g.gain.setValueAtTime(vol, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime + dur);
    },
    win: () => { Sound.play(400,'sine',0.1); setTimeout(()=>Sound.play(600,'sine',0.1),100); setTimeout(()=>Sound.play(800,'triangle',0.4,0.2),200); },
    click: () => { 
        Sound.play(300,'sine',0.05,0.05);
        if(navigator.vibrate) navigator.vibrate(10); // Haptic
    },
    error: () => {
        Sound.play(150,'sawtooth',0.3,0.08);
        if(navigator.vibrate) navigator.vibrate([30, 50, 30]); // Haptic Pattern
    },
    merge: () => {
        Sound.play(500,'square',0.05,0.05);
        if(navigator.vibrate) navigator.vibrate(20);
    }
};

const Storage = {
    get: () => JSON.parse(localStorage.getItem('brainBuddy_v24')) || {},
    save: (d) => localStorage.setItem('brainBuddy_v24', JSON.stringify(d)),
    check: (id, diff, score, mode) => {
        const d = Storage.get();
        const cur = d[`${id}_${diff}`];
        if(!cur) return true;
        if (mode === 'score') return score > cur.score;
        return score < cur.score; 
    },
    set: (id, diff, name, score) => {
        const d = Storage.get();
        d[`${id}_${diff}`] = { name, score, date: new Date().toLocaleDateString() };
        Storage.save(d);
    }
};

const Confetti = {
    canvas: document.getElementById('confetti-canvas'),
    ctx: document.getElementById('confetti-canvas').getContext('2d'),
    particles: [], active: false,
    resize: function() { this.canvas.width=window.innerWidth; this.canvas.height=window.innerHeight; },
    start: function() {
        this.resize(); this.particles=[];
        const colors = ['#6366f1', '#a855f7', '#38bdf8', '#10b981', '#fbbf24'];
        for(let i=0; i<100; i++) this.particles.push({ x: Math.random()*this.canvas.width, y: Math.random()*this.canvas.height-this.canvas.height, c: colors[Math.floor(Math.random()*colors.length)], vx: Math.random()*2-1, vy: Math.random()*3+2, s: Math.random()*8+4 });
        this.active=true; this.loop(); setTimeout(()=>this.stop(), 3000);
    },
    stop: function() { this.active=false; this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height); },
    loop: function() {
        if(!this.active) return;
        this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
        this.particles.forEach(p=>{ p.y+=p.vy; p.x+=p.vx; this.ctx.fillStyle=p.c; this.ctx.fillRect(p.x,p.y,p.s,p.s); if(p.y>this.canvas.height) p.y=-10; });
        requestAnimationFrame(()=>this.loop());
    }
};

/* --- FIXED PUZZLE LOGIC (CANVAS GEN) --- */
const PuzzleThemes = {
    easy: { t: 'Manzana', e: 'üçé', c: '#fecaca' },
    medium: { t: 'Emoji', e: 'üòé', c: '#fde047' },
    hard: { t: 'Alien', e: 'üëΩ', c: '#a78bfa' },
    extreme: { t: 'Diablo', e: 'üëø', c: '#f87171' }
};

class SlidingGame {
    constructor(diff) {
        this.diff = diff; 
        this.sz = diff==='easy'?3:(diff==='medium'?4:5);
        this.theme = PuzzleThemes[diff] || PuzzleThemes.easy;
        this.board = []; 
        this.emptyIdx = -1;
        this.moves = 0;
        this.imgData = null;
    }
    init(c) {
        this.c = c;
        this.imgData = this.generateImage();
        this.board = Array.from({length: this.sz*this.sz}, (_, i) => i);
        this.board[this.sz*this.sz - 1] = -1; 
        this.emptyIdx = this.sz*this.sz - 1;
        
        let shuffles = this.sz === 3 ? 50 : 150;
        let lastMove = -1;
        for(let i=0; i<shuffles; i++) {
            const neighbors = this.getNeighbors(this.emptyIdx);
            const valid = neighbors.filter(n => n !== lastMove);
            if(valid.length > 0) {
                const move = valid[Math.floor(Math.random() * valid.length)];
                [this.board[this.emptyIdx], this.board[move]] = [this.board[move], this.board[this.emptyIdx]];
                lastMove = this.emptyIdx;
                this.emptyIdx = move;
            }
        }
        this.moves = 0;
        this.render();
    }
    generateImage() {
        const cvs = document.createElement('canvas');
        const s = 400; // Resolution
        cvs.width = s; cvs.height = s;
        const ctx = cvs.getContext('2d');
        ctx.fillStyle = this.theme.c;
        ctx.fillRect(0,0,s,s);
        ctx.font = `${s*0.6}px serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(this.theme.e, s/2, s/2);
        return cvs.toDataURL();
    }
    getNeighbors(idx) {
        const r = Math.floor(idx / this.sz);
        const c = idx % this.sz;
        const n = [];
        if(r > 0) n.push(idx - this.sz); 
        if(r < this.sz - 1) n.push(idx + this.sz); 
        if(c > 0) n.push(idx - 1); 
        if(c < this.sz - 1) n.push(idx + 1); 
        return n;
    }
    render() {
        $('#stat-2').textContent = `Mov: ${this.moves}`;
        const bgSize = this.sz * 100;
        this.c.innerHTML = `
            <div class="slide-grid" style="grid-template-columns:repeat(${this.sz},1fr); width:${this.sz*70}px;">
                ${this.board.map((val, i) => {
                    let style = '';
                    if(val !== -1) {
                        const r = Math.floor(val / this.sz);
                        const c = val % this.sz;
                        const x = (c / (this.sz - 1)) * 100;
                        const y = (r / (this.sz - 1)) * 100;
                        style = `background-image: url('${this.imgData}'); background-size: ${bgSize}%; background-position: ${x}% ${y}%`;
                    }
                    return `<div class="slide-tile ${val===-1?'empty':''}" style="${style}" onclick="App.curr.click(${i})"></div>`;
                }).join('')}
            </div>
            <div style="text-align:center; margin-top:15px; font-size:0.9rem; color:var(--text-muted)">Reconstruye: ${this.theme.t}</div>
        `;
    }
    click(idx) {
        const neighbors = this.getNeighbors(this.emptyIdx);
        if(neighbors.includes(idx)) {
            [this.board[this.emptyIdx], this.board[idx]] = [this.board[idx], this.board[this.emptyIdx]];
            this.emptyIdx = idx;
            this.moves++;
            Sound.click();
            this.render();
            this.checkWin();
        } else {
            Sound.error();
        }
    }
    checkWin() {
        for(let i=0; i<this.board.length-1; i++) if(this.board[i] !== i) return;
        App.endGame(true);
    }
}

// 14. Emoji Equation
class EquationGame {
    constructor(diff) {
        this.diff = diff; this.score = 0; this.streak = 0;
        this.emojis = ['üçé','üçå','üçï','üçî','üéà','‚≠ê','üåµ','üçÑ','üêô','üê±'];
    }
    init(c) { this.c = c; this.next(); }
    next() {
        $('#stat-2').textContent = `Pts: ${this.score}`;
        const icons = [...this.emojis].sort(()=>0.5-Math.random()).slice(0,2);
        const [A, B] = icons;
        const valA = Math.floor(Math.random()*8)+2; 
        const valB = Math.floor(Math.random()*8)+1;
        const line1_res = valA * 2;
        const line2_res = valA + valB;
        let questionHTML = `${B} + ${B}`;
        let finalAns = valB + valB;
        if(this.diff === 'hard' || this.diff === 'extreme') {
             if(Math.random() > 0.5) { questionHTML = `${B} + ${A}`; finalAns = valB + valA; }
        }
        const options = [finalAns];
        while(options.length < 4) {
            let fake = finalAns + Math.floor(Math.random()*10)-5;
            if(!options.includes(fake) && fake !== finalAns && fake >= 0) options.push(fake);
        }
        this.c.innerHTML = `<div class="eq-container"><div class="eq-row"><div class="eq-item">${A} + ${A}</div><div>= ${line1_res}</div></div><div class="eq-row"><div class="eq-item">${A} + ${B}</div><div>= ${line2_res}</div></div><div class="eq-row" style="border:2px solid var(--accent); background:rgba(99, 102, 241, 0.1);"><div class="eq-item">${questionHTML}</div><div>= <span style="color:var(--highlight)">?</span></div></div><div class="choice-grid">${options.sort(()=>0.5-Math.random()).map(o => `<button class="choice-btn" onclick="App.curr.check(${o}, ${finalAns})">${o}</button>`).join('')}</div></div>`;
    }
    check(val, correct) {
        if(val === correct) {
            this.score += 10; this.streak++; Sound.click();
            if(this.streak % 3 === 0) App.addTime(3, true);
            this.next();
        } else {
            this.score = Math.max(0, this.score - 5); this.streak = 0; Sound.error(); App.visualPenalty(); this.next();
        }
    }
}

// 15. Emoji Hunt
class HuntGame {
    constructor(diff) {
        this.diff = diff; this.score = 0; 
        this.sz = diff==='easy'?5:(diff==='medium'?6:8);
        this.targetCount = 3; this.found = 0;
        this.pool = ['üòÄ','üòÇ','üòç','üòé','ü§¨','ü§¢','ü§°','üëª','üëΩ','ü§ñ','üí©','üë∫','üíÄ','ü§ï','ü§†','ü•∏','üòá','üéÉ','üçé','üçå','üçí','üçï','üöó','üöÄ','‚öΩ'];
    }
    init(c) { this.c = c; this.load(); }
    load() {
        this.found = 0;
        const target = this.pool[Math.floor(Math.random()*this.pool.length)];
        let distractors = this.pool.filter(x => x !== target);
        const totalCells = this.sz * this.sz;
        const grid = [];
        for(let i=0; i<this.targetCount; i++) grid.push({v:target, t:true});
        while(grid.length < totalCells) grid.push({v: distractors[Math.floor(Math.random()*distractors.length)], t:false});
        grid.sort(()=>0.5-Math.random());
        $('#stat-2').textContent = `Pts: ${this.score}`;
        this.c.innerHTML = `<div style="text-align:center; margin-bottom:10px; font-size:1.1rem">Busca: <span style="font-size:1.5rem; border:1px solid #555; padding:0 5px; border-radius:5px">${target}</span> (<span id="hunt-count">0</span>/${this.targetCount})</div><div class="hunt-grid" style="grid-template-columns:repeat(${this.sz},1fr); width:${Math.min(380, this.sz*45)}px;">${grid.map((item, i) => `<div class="hunt-cell" onclick="App.curr.click(this, ${item.t})">${item.v}</div>`).join('')}</div>`;
    }
    click(el, isTarget) {
        if(el.classList.contains('found')) return;
        if(isTarget) {
            el.classList.add('found'); this.found++; $('#hunt-count').textContent = this.found; Sound.click();
            if(this.found === this.targetCount) { this.score += 20; Sound.merge(); App.addTime(3, true); setTimeout(() => this.load(), 500); }
        } else { this.score = Math.max(0, this.score - 5); Sound.error(); App.visualPenalty(); }
    }
}

/* --- OTHER GAMES (Condensed) --- */
class EagleGame{constructor(d){this.d=d;this.l=1;this.s=0;this.bs=2;}init(c){this.c=c;this.ld();}ld(){const sz=Math.min(8,this.bs+Math.floor(this.l/2)),tot=sz*sz,tgt=Math.floor(Math.random()*tot),h=Math.floor(Math.random()*360);let dt=Math.max(3,25-(this.l*1.5));if(this.d==='medium')dt*=.8;if(this.d==='hard')dt*=.6;const c1=`hsl(${h},80%,50%)`,c2=`hsl(${h},80%,${50+dt}%)`;$('#stat-2').textContent=`Pts: ${this.s}`;this.c.innerHTML=`<div class="eagle-grid" style="grid-template-columns:repeat(${sz},1fr);width:${Math.min(350,sz*60)}px">${Array(tot).fill(0).map((_,i)=>`<div class="eagle-cell" style="background:${i===tgt?c2:c1};aspect-ratio:1" onclick="App.curr.ck(${i===tgt})"></div>`).join('')}</div><div style="margin-top:15px;color:#999;font-size:0.9rem">Encuentra el diferente</div>`;}ck(t){if(t){this.s+=10;this.l++;Sound.click();App.addTime(1,true);this.ld();}else{this.s=Math.max(0,this.s-5);Sound.error();App.visualPenalty();}}}
class ChimpGame{constructor(d){this.l=4;this.mx=d==='easy'?8:12;this.lv=3;this.c=1;}init(c){this.cn=c;this.ld();}ld(){this.c=1;$('#stat-2').textContent=`Nivel ${this.l} ‚ù§Ô∏è${this.lv}`;const sz=this.l<=9?5:6,p=[];while(p.length<this.l){let x=Math.floor(Math.random()*sz*sz);if(!p.includes(x))p.push(x);}this.cn.innerHTML=`<div class="chimp-grid" style="grid-template-columns:repeat(${sz},1fr);width:${sz*60}px">${Array(sz*sz).fill(0).map((_,i)=>{let k=p.indexOf(i);return k!=-1?`<div class="chimp-cell" id="ch-${i}" onclick="App.curr.ck(${i},${k+1})">${k+1}</div>`:`<div class="chimp-cell hidden"></div>`}).join('')}</div>`;}ck(i,n){if(n!=this.c){this.lv--;Sound.error();if(this.lv<=0)App.endGame(true);else{alert("¬°Fallo!");this.ld();}return;}Sound.click();if(this.c===1)$$('.chimp-cell').forEach(e=>{if(e.textContent!=='1'&&!e.classList.contains('hidden'))e.classList.add('covered')});$(`#ch-${i}`).classList.add('hidden');this.c++;if(this.c>this.l){Sound.merge();this.l++;setTimeout(()=>this.ld(),500);}}get score(){return this.l;}}
class SorterGame{constructor(d){this.s=0;this.m=d==='easy'||d==='medium'?'n':'c';}init(c){this.c=c;document.onkeydown=e=>{if(e.key==='ArrowLeft')this.ck(0);if(e.key==='ArrowRight')this.ck(1);};this.nx();}nx(){$('#stat-2').textContent=`Pts: ${this.s}`;let t,y;if(this.m==='n'){t=Math.floor(Math.random()*100);y=t%2===0?0:1;}else{let v="AEIOU",k="BCDFGHJKLMNPQRSTVWXYZ";if(Math.random()>.5){t=v[Math.floor(Math.random()*v.length)];y=0;}else{t=k[Math.floor(Math.random()*k.length)];y=1;}}this.cur=y;this.c.innerHTML=`<div class="sorter-container"><div class="sorter-card">${t}</div><div class="sorter-controls"><button class="sorter-btn btn-left" onclick="App.curr.ck(0)">${this.m==='n'?'PAR':'VOCAL'}</button><button class="sorter-btn btn-right" onclick="App.curr.ck(1)">${this.m==='n'?'IMPAR':'CONS'}</button></div></div>`;}ck(s){if(s===this.cur){this.s+=5;Sound.click();}else{this.s=Math.max(0,this.s-5);Sound.error();App.visualPenalty();}this.nx();}}
class StopwatchGame{constructor(d){this.t=d==='hard'||d==='easy'?10:(d==='extreme'?15:5);this.lm=(d==='hard')?4:((d==='extreme')?5:999);this.s=0;this.r=0;this.at=3;}init(c){this.c=c;this.rn();}rn(){$('#stat-2').textContent=`Pts: ${this.s.toFixed(0)} | ${this.at}`;this.c.innerHTML=`<div style="text-align:center"><div class="stopwatch-target">META: ${this.t}.00s</div><div class="stopwatch-display">0.00</div><button class="stopwatch-btn ${this.r?'running':''}" onclick="App.curr.tg()">${this.r?'STOP':'START'}</button><div style="margin-top:20px;color:#888">${this.lm<99?`Oculto a ${this.lm}s`:''}</div></div>`;}tg(){if(!this.r){if(this.at<=0)return;this.r=1;this.st=Date.now();Sound.click();this.rn();this.lp();}else this.sp();}lp(){if(!this.r)return;let d=(Date.now()-this.st)/1000,dp=$('.stopwatch-display');dp.textContent=d>this.lm?"?.??":d.toFixed(2);if(d>this.lm)dp.style.color='#555';else dp.style.color='var(--accent)';requestAnimationFrame(()=>this.lp());}sp(){this.r=0;let a=(Date.now()-this.st)/1000,df=Math.abs(a-this.t);$('.stopwatch-display').textContent=a.toFixed(3);this.s+=Math.max(0,100-(df*100));this.at--;Sound.win();setTimeout(()=>{if(this.at<=0)App.endGame(true);else this.rn();},2000);}}
class MemoryGame{constructor(d){this.c=[];this.f=[];this.l=0;this.m=0;this.sk=0;let sz=d==='easy'?4:5;if(d==='hard')sz=6;this.rw=sz===5?4:sz;let t=['üçé','üçå','üçí','üçá','üçâ','üçã','ü•ù','ü••','ü•ë','üçÜ','ü•ï','üåΩ'];let p=[];while(p.length<(sz*this.rw)/2)p.push(t[Math.floor(Math.random()*t.length)]);this.c=[...p,...p].sort(()=>.5-Math.random());this.sz=sz;}init(c){c.innerHTML=`<div class="memory-grid" style="grid-template-columns:repeat(${this.sz},1fr)">${this.c.map((e,i)=>`<div class="memory-card" id="mc-${i}" onclick="App.curr.fl(${i})"><div class="front">${e}</div><div class="back"></div></div>`).join('')}</div>`;}fl(i){let e=$(`#mc-${i}`);if(this.l||e.classList.contains('flip'))return;e.classList.add('flip');Sound.click();this.f.push({id:i,v:this.c[i],e:e});if(this.f.length===2){this.l=1;App.moves++;if(this.f[0].v===this.f[1].v){this.m++;this.sk++;if(this.sk>=2){App.addTime(5,0);this.sk=0;}this.f=[];this.l=0;if(this.m===this.c.length/2)App.endGame(true);}else{this.sk=0;Sound.error();setTimeout(()=>{this.f.forEach(x=>x.e.classList.remove('flip'));this.f=[];this.l=0;},800);}}}}
class MathGame{constructor(d){this.d=d;this.s=0;this.c=0;}init(c){c.innerHTML=`<div style="text-align:center"><div class="stroop-word" id="mq"></div><div class="choice-grid" id="mo"></div></div>`;this.nx();}nx(){let o=['+','-','*'],op=o[Math.floor(Math.random()*3)],a=Math.floor(Math.random()*9)+2,b=Math.floor(Math.random()*9)+2,r=op==='+'?a+b:(op==='-'?a-b:a*b);$('#mq').textContent=`${a} ${op} ${b}`;$('#stat-2').textContent=`Pts: ${this.s}`;let ch=[r];while(ch.length<4){let x=r+Math.floor(Math.random()*10)-5;if(!ch.includes(x))ch.push(x);}$('#mo').innerHTML=ch.sort(()=>.5-Math.random()).map(x=>`<button class="choice-btn" onclick="App.curr.ck(${x},${r})">${x}</button>`).join('');}ck(v,r){if(v===r){this.s+=10;this.c++;Sound.click();if(this.c%3===0)App.addTime(2,1);this.nx();}else{this.s=Math.max(0,this.s-5);this.c=0;Sound.error();App.visualPenalty();this.nx();}}}
class AnagramGame{constructor(d){this.s=0;this.c=0;this.w=['SOL','MAR','LUZ','PAN','RIO','GATO','PATO','CASA','AGUA','MESA','ARBOL','LIBRO','PLAYA'];this.t=[];this.sl=[];this.pl=[];}init(c){this.cn=c;this.ld();document.onkeydown=e=>{if(e.key.match(/[a-z]/i)){let f=this.pl.find(x=>x.l===e.key.toUpperCase());if(f)this.cp(f.id);}if(e.key==='Backspace'){let i=this.sl.map((x,k)=>x?k:-1).filter(x=>x!==-1).pop();if(i!==undefined)this.cs(i);}};}ld(){if(!this.t.length)this.t=[...this.w].sort(()=>.5-Math.random());this.cw=this.t.pop();this.pl=this.cw.split('').sort(()=>.5-Math.random()).map((l,i)=>({l,id:i}));this.sl=Array(this.cw.length).fill(null);this.rn();}rn(){$('#stat-2').textContent=`Pts: ${this.s}`;this.cn.innerHTML=`<div class="anagram-slots">${this.sl.map((x,i)=>x?`<div class="letter-btn" onclick="App.curr.cs(${i})">${x.l}</div>`:`<div class="letter-btn empty"></div>`).join('')}</div><div class="anagram-pool">${this.pl.map(x=>`<div class="letter-btn" onclick="App.curr.cp(${x.id})">${x.l}</div>`).join('')}</div>`;}cp(id){let p=this.pl.findIndex(x=>x.id===id),s=this.sl.findIndex(x=>x===null);if(p>-1&&s>-1){this.sl[s]=this.pl[p];this.pl.splice(p,1);Sound.click();this.rn();this.chk();}}cs(i){if(this.sl[i]){this.pl.push(this.sl[i]);this.sl[i]=null;Sound.click();this.rn();}}chk(){if(!this.sl.includes(null)){if(this.sl.map(x=>x.l).join('')===this.cw){Sound.merge();this.s+=10;this.c++;if(this.c%3===0)App.addTime(3,1);setTimeout(()=>this.ld(),300);}else{Sound.error();this.s=Math.max(0,this.s-5);this.c=0;App.visualPenalty();this.pl=this.cw.split('').sort(()=>.5-Math.random()).map((l,i)=>({l,id:i}));this.sl=Array(this.cw.length).fill(null);setTimeout(()=>this.rn(),300);}}}}
class MatrixGame{constructor(d){this.r=1;this.mx=5;this.sz=d==='easy'?3:d==='medium'?4:5;this.tc=this.sz===3?3:this.sz===4?5:7;this.ok=0;this.sl=[];this.tg=[];}init(c){this.c=c;this.ld();}ld(){if(this.r>this.mx){App.endGame(true);return;}$('#stat-2').textContent=`Ronda ${this.r}/${this.mx}`;this.c.innerHTML=`<div class="matrix-grid" style="grid-template-columns:repeat(${this.sz},1fr);width:${this.sz*60}px">${Array(this.sz*this.sz).fill(0).map((_,i)=>`<div class="matrix-cell" id="mt-${i}" onclick="App.curr.ck(${i})"></div>`).join('')}</div>`;this.tg=[];while(this.tg.length<this.tc){let x=Math.floor(Math.random()*this.sz*this.sz);if(!this.tg.includes(x))this.tg.push(x);}setTimeout(()=>{this.tg.forEach(x=>$(`#mt-${x}`).classList.add('active'));Sound.click();},500);setTimeout(()=>{this.tg.forEach(x=>$(`#mt-${x}`).classList.remove('active'));this.ok=1;this.sl=[];},2000);}ck(i){if(!this.ok||this.sl.includes(i))return;if(this.tg.includes(i)){$(`#mt-${i}`).classList.add('ok');this.sl.push(i);Sound.click();if(this.sl.length===this.tc){this.ok=0;Sound.merge();setTimeout(()=>{this.r++;this.ld();},800);}}else{$(`#mt-${i}`).classList.add('fail');Sound.error();this.ok=0;this.tg.forEach(x=>$(`#mt-${x}`).classList.add('active'));setTimeout(()=>this.ld(),1500);}}}
class SchulteGame{constructor(d){this.sz=d==='easy'?3:d==='medium'?4:5;this.cur=1;}init(c){let n=Array.from({length:this.sz*this.sz},(_,i)=>i+1).sort(()=>.5-Math.random());$('#stat-2').textContent='Busca: 1';c.innerHTML=`<div class="schulte-grid" style="grid-template-columns:repeat(${this.sz},1fr);width:${this.sz*55}px">${n.map(x=>`<div class="schulte-cell" onclick="App.curr.ck(this,${x})">${x}</div>`).join('')}</div>`;}ck(e,v){if(v===this.cur){Sound.click();e.style.opacity=.3;e.style.pointerEvents='none';this.cur++;if(this.cur>this.sz*this.sz)App.endGame(true);else $('#stat-2').textContent=`Busca: ${this.cur}`;}else Sound.error();}}
class Sudoku{constructor(){this.s=[];this.b=[];}init(c){c.innerHTML=`<div class="sudoku-grid" id="sb"></div><div class="numpad" id="sp"></div>`;this.gn();let b=$('#sb');this.b.forEach((r,i)=>r.forEach((v,j)=>{let d=document.createElement('div');d.className=`sudoku-cell ${v?'initial':''}`;d.textContent=v||'';d.onclick=()=>!v&&this.sl(d,i,j);b.appendChild(d);}));[1,2,3,4,5,6,7,8,9,'‚å´'].forEach(x=>{let btn=document.createElement('button');btn.textContent=x;btn.onclick=()=>this.inp(x);$('#sp').appendChild(btn);});}sl(e,r,c){$$('.selected').forEach(x=>x.classList.remove('selected'));this.cr={e,r,c};e.classList.add('selected');}inp(v){if(this.cr){let n=v==='‚å´'?0:v;this.cr.e.textContent=n||'';this.b[this.cr.r][this.cr.c]=n;if(n&&n!=this.s[this.cr.r][this.cr.c]){this.cr.e.classList.add('error');Sound.error();}else{this.cr.e.classList.remove('error');Sound.click();if(this.b.every((r,i)=>r.every((c,j)=>c===this.s[i][j])))App.endGame(true);}}}gn(){this.s=Array(9).fill().map(()=>Array(9).fill(0));const f=(r,c)=>{let n=[1,2,3,4,5,6,7,8,9].sort(()=>.5-Math.random());for(let x of n){let ok=1;for(let k=0;k<9;k++)if(this.s[r][k]===x||this.s[k][c]===x)ok=0;let br=Math.floor(r/3)*3,bc=Math.floor(c/3)*3;for(let i=0;i<3;i++)for(let j=0;j<3;j++)if(this.s[br+i][bc+j]===x)ok=0;if(ok){this.s[r][c]=x;if(c===8?(r===8?1:f(r+1,0)):f(r,c+1))return 1;this.s[r][c]=0;}}return 0;};f(0,0);this.b=JSON.parse(JSON.stringify(this.s));let k=30;while(k>0){let r=Math.floor(Math.random()*9),c=Math.floor(Math.random()*9);if(this.b[r][c]){this.b[r][c]=0;k--;}}}}
class WordSearch{constructor(){this.sz=10;this.w=['JAVA','WEB','CODE','DATA','APP'];this.bd=[];this.fd=0;}init(c){c.innerHTML=`<div style="text-align:center;margin-bottom:10px">${this.w.join(' ')}</div><div class="ws-grid" style="grid-template-columns:repeat(10,1fr);width:280px" id="wb"></div>`;this.gn();let b=$('#wb');this.bd.forEach((r,i)=>r.forEach((l,j)=>{let d=document.createElement('div');d.className='ws-cell';d.textContent=l;d.dataset.r=i;d.dataset.c=j;b.appendChild(d);}));this.ev(b);}gn(){this.bd=Array(10).fill().map(()=>Array(10).fill(''));this.w.forEach(w=>{let p=0;while(!p){let d=Math.floor(Math.random()*2),r=Math.floor(Math.random()*10),c=Math.floor(Math.random()*10);if((d&&r+w.length<=10)||(!d&&c+w.length<=10)){let ok=1;for(let i=0;i<w.length;i++)if(this.bd[r+(d?i:0)][c+(d?0:i)])ok=0;if(ok){for(let i=0;i<w.length;i++)this.bd[r+(d?i:0)][c+(d?0:i)]=w[i];p=1;}}}});let a="ABCDEFGHIJKLMNOPQRSTUVWXYZ";for(let i=0;i<10;i++)for(let j=0;j<10;j++)if(!this.bd[i][j])this.bd[i][j]=a[Math.floor(Math.random()*a.length)];}ev(b){let s=0,st,ph=[];const g=e=>e.target.closest('.ws-cell')||(e.touches?document.elementFromPoint(e.touches[0].clientX,e.touches[0].clientY)?.closest('.ws-cell'):null);b.onmousedown=e=>{let c=g(e);if(c){s=1;st={r:+c.dataset.r,c:+c.dataset.c};}};b.onmousemove=e=>{if(s){let c=g(e);if(c){$$('.selected').forEach(x=>x.classList.remove('selected'));let en={r:+c.dataset.r,c:+c.dataset.c},dr=en.r-st.r,dc=en.c-st.c;ph=[];if(!dr||!dc||Math.abs(dr)===Math.abs(dc)){let mx=Math.max(Math.abs(dr),Math.abs(dc)),ir=dr?dr/Math.abs(dr):0,ic=dc?dc/Math.abs(dc):0;for(let i=0;i<=mx;i++)ph.push({r:st.r+i*ir,c:st.c+i*ic});ph.forEach(p=>$(`.ws-cell[data-r="${p.r}"][data-c="${p.c}"]`)?.classList.add('selected'));}}}};document.onmouseup=()=>{if(s){s=0;let t=ph.map(p=>this.bd[p.r][p.c]).join('');if(this.w.includes(t)){this.fd++;ph.forEach(p=>$(`.ws-cell[data-r="${p.r}"][data-c="${p.c}"]`).classList.add('found'));Sound.click();if(this.fd===this.w.length)App.endGame(true);}$$('.selected').forEach(x=>x.classList.remove('selected'));}};b.ontouchstart=b.onmousedown;b.ontouchmove=b.onmousemove;document.ontouchend=document.onmouseup;}}
class DiffGame{constructor(){this.l=1;}init(c){this.c=c;this.ld();}ld(){let sz=Math.min(this.l+2,6),e=['üòÄ','üòé','üëΩ'],b=e[0],d=e[1],t=Math.floor(Math.random()*sz*sz);this.c.innerHTML=`<div class="diff-grid" style="grid-template-columns:repeat(${sz},1fr);gap:4px;max-width:300px;margin:0 auto">${Array(sz*sz).fill(0).map((_,i)=>`<div class="diff-cell" onclick="${i===t?'App.curr.ok()':'Sound.error()'}">${i===t?d:b}</div>`).join('')}</div>`;}ok(){Sound.click();this.l++;if(this.l>5)App.endGame(true);else this.ld();}}
class StroopGame{constructor(){this.s=0;}init(c){c.innerHTML=`<div style="text-align:center"><div id="sq"></div><div id="sw" style="font-size:3rem;font-weight:bold;margin:20px"></div><div class="choice-grid" id="so"></div></div>`;this.nx();}nx(){let cl=[{n:'ROJO',c:'#f00'},{n:'AZUL',c:'#00f'}],t=cl[Math.floor(Math.random()*2)],c=cl[t.n==='ROJO'?1:0],m=Math.random()>.5;$('#sq').textContent=m?'¬øCOLOR?':'¬øDICE?';$('#sw').textContent=t.n;$('#sw').style.color=c.c;let a=m?c.n:t.n,o=[a,'VERDE'];$('#so').innerHTML=o.sort(()=>.5-Math.random()).map(x=>`<button class="choice-btn" onclick="App.curr.ck('${x}','${a}')">${x}</button>`).join('');}ck(v,r){if(v===r){this.s++;Sound.click();if(this.s>9)App.endGame(true);else this.nx();}else Sound.error();}}

/* --- CONTROLLER --- */
const App = {
    curr: null, type: null, diff: 'easy', time: 0, timer: null, moves: 0,
    list: [
        { id:'mem', t:'Memoria', i:'üß©', d:'Parejas', c:MemoryGame, mode:'time' },
        { id:'mat', t:'C√°lculo', i:'‚úñÔ∏è', d:'Arcade', c:MathGame, mode:'score' },
        { id:'sld', t:'Puzzle', i:'üñºÔ∏è', d:'Imagen', c:SlidingGame, mode:'time' }, // FIXED
        { id:'ana', t:'Anagrama', i:'üî°', d:'Arcade', c:AnagramGame, mode:'score' },
        { id:'eq', t:'Ecuaci√≥n', i:'üßÆ', d:'Emoji', c:EquationGame, mode:'score' },
        { id:'hnt', t:'Caza', i:'üïµÔ∏è', d:'Emojis', c:HuntGame, mode:'score' },
        { id:'eag', t:'√Åguila', i:'ü¶Ö', d:'Visi√≥n', c:EagleGame, mode:'score' },
        { id:'chp', t:'Chimpanc√©', i:'üêµ', d:'Memoria', c:ChimpGame, mode:'score' },
        { id:'srt', t:'Clasifica', i:'‚öñÔ∏è', d:'Veloz', c:SorterGame, mode:'score' },
        { id:'stw', t:'Cron√≥metro', i:'‚è±Ô∏è', d:'Mental', c:StopwatchGame, mode:'score' },
        { id:'mtx', t:'Matriz', i:'üü¶', d:'Patrones', c:MatrixGame, mode:'time' },
        { id:'sch', t:'Schulte', i:'üî¢', d:'Atenci√≥n', c:SchulteGame, mode:'time' },
        { id:'sud', t:'Sudoku', i:'‚úèÔ∏è', d:'L√≥gica', c:Sudoku, mode:'time' },
        { id:'wrd', t:'Sopa Letras', i:'üîé', d:'Buscar', c:WordSearch, mode:'time' },
        { id:'dif', t:'Intruso', i:'üßê', d:'Visual', c:DiffGame, mode:'time' },
        { id:'str', t:'Confusi√≥n', i:'üé®', d:'Stroop', c:StroopGame, mode:'time' }
    ],

    init: () => {
        const g = $('.game-grid');
        App.list.forEach(i => {
            const c = document.createElement('div'); c.className = 'game-card';
            c.innerHTML = `<div><span class="game-icon">${i.i}</span><div class="game-title">${i.t}</div><div class="game-desc">${i.d}</div></div>`;
            c.onclick = () => App.load(i);
            g.appendChild(c);
        });
        window.addEventListener('resize', ()=>Confetti.resize());
        
        // Generate Icons on Load
        if(window.generateIcons) window.generateIcons();
    },

    load: (type) => {
        App.type = type; 
        App.diff = 'easy'; $('#difficulty-select').value = 'easy';
        $('#view-menu').classList.remove('active');
        $('#view-game').classList.add('active');
        $('#game-title-display').textContent = type.t;
        App.run();
    },

    run: () => {
        clearInterval(App.timer); 
        App.moves = 0;
        $('#game-board-area').innerHTML = '';
        
        if(App.type.mode === 'score' && App.type.id !== 'chp' && App.type.id !== 'stw') {
            App.time = 60; 
        } else {
            App.time = 0; 
        }
        
        App.updateTimerDisplay();
        App.curr = new App.type.c(App.diff);
        App.curr.init($('#game-board-area'));
        
        if(App.type.id === 'stw') return;

        App.timer = setInterval(() => {
            if(App.type.mode === 'score' && App.type.id !== 'chp') {
                App.time--;
                if(App.time <= 0) App.endGame(true);
            } else {
                App.time++;
            }
            App.updateTimerDisplay();
        }, 1000);
    },

    addTime: (sec, isBonus) => {
        const bar = $('.stats-bar');
        if (App.type.mode === 'score') App.time += sec; 
        else App.time = Math.max(0, App.time - sec);
        App.updateTimerDisplay();
        bar.classList.remove('time-bonus', 'time-penalty');
        void bar.offsetWidth; 
        bar.classList.add(isBonus ? 'time-bonus' : 'time-penalty');
    },

    visualPenalty: () => {
        const bar = $('.stats-bar');
        bar.classList.remove('time-bonus', 'time-penalty');
        void bar.offsetWidth;
        bar.classList.add('time-penalty');
    },

    updateTimerDisplay: () => {
        if(App.type.id === 'stw') return;
        if (App.type.mode === 'score' && App.type.id !== 'chp') {
            $('#stat-1').textContent = `${App.time}s`;
        } else {
            const m = Math.floor(App.time / 60).toString().padStart(2, '0');
            const s = (App.time % 60).toString().padStart(2, '0');
            $('#stat-1').textContent = `${m}:${s}`;
        }
    },

    changeDifficulty: (v) => { App.diff = v; App.run(); },
    restartGame: () => { 
        if(App.curr && App.curr.stop) App.curr.stop();
        Sound.click(); App.run(); 
    },
    
    confirmExit: (e) => { 
        if(e) e.preventDefault();
        if(confirm("¬øVolver al men√∫?")) App.toMenu(); 
    },

    toMenu: () => {
        clearInterval(App.timer);
        if(App.curr && App.curr.stop) App.curr.stop();
        $('#view-game').classList.remove('active');
        $('#view-menu').classList.add('active');
        $('#modal-win').classList.remove('active');
        document.onkeydown = null; 
        document.onmouseup = null;
        document.ontouchend = null;
    },

    endGame: (win) => {
        if(!win) return;
        clearInterval(App.timer); Sound.win(); Confetti.start();
        document.onkeydown = null; document.onmouseup = null; document.ontouchend = null;
        
        let scoreToSave = App.time; 
        let msg = `Tiempo: ${$('#stat-1').textContent}`;

        if(App.type.mode === 'score') {
            scoreToSave = App.curr.score || App.curr.level || 0;
            msg = `Puntaje Final: ${scoreToSave}`;
        }

        const rec = Storage.check(App.type.id, App.diff, scoreToSave, App.type.mode);
        $('#win-message').textContent = msg;
        
        $('#record-section').style.display = rec ? 'block' : 'none';
        if(rec) { $('#player-name').value=''; setTimeout(()=>$('#player-name').focus(), 100); }
        $('#modal-win').classList.add('active');
        App.lastScore = scoreToSave;
    },

    handleWinAction: (act) => {
        const inp = $('#player-name');
        if($('#record-section').style.display !== 'none' && inp.value.trim()) {
            Storage.set(App.type.id, App.diff, inp.value.trim(), App.lastScore);
        }
        $('#modal-win').classList.remove('active');
        if(act === 'replay') App.run(); else App.toMenu();
    },

    showRankingGlobal: () => {
        const d = Storage.get(); const l = $('#ranking-list'); l.innerHTML = '';
        if(Object.keys(d).length === 0) l.innerHTML = '<p style="color:#aaa;text-align:center">Sin r√©cords.</p>';
        else {
            App.list.forEach(g => {
                let html = '';
                ['easy','medium','hard','extreme'].forEach(lvl => {
                    const k = `${g.id}_${lvl}`;
                    if(d[k]) {
                        let val = '';
                        if(g.mode === 'score') {
                            val = `${d[k].score} pts`;
                            if(g.id === 'chp') val = `Nivel ${d[k].score}`;
                        } else {
                            const m = Math.floor(d[k].score/60).toString().padStart(2,'0');
                            const s = (d[k].score%60).toString().padStart(2,'0');
                            val = `${m}:${s}`;
                        }
                        html += `<li><span>${lvl.toUpperCase()}</span> <b>${d[k].name} (${val})</b></li>`;
                    }
                });
                if(html) l.innerHTML += `<h3 style="color:var(--primary);margin-top:15px;font-size:1rem">${g.i} ${g.t}</h3><ul>${html}</ul>`;
            });
        }
        $('#modal-ranking').classList.add('active');
    }
};

window.onload = App.init;
</script>
</body>
</html>

