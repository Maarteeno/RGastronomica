<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brain Buddy - Arcade Ultimate</title>
    <style>
        :root {
            /* Palette Dark Elegant */
            --bg-body: #0f172a; 
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 60%, #312e81 100%);
            
            --glass-bg: rgba(30, 41, 59, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            
            --primary: #6366f1;    /* Indigo */
            --secondary: #a855f7;  /* Purple */
            --accent: #38bdf8;     /* Sky */
            --highlight: #fbbf24;  /* Amber */
            
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            --success: #10b981;
            --danger: #f43f5e;
            
            --radius: 16px;
            --font-main: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --shadow: 0 10px 40px -10px rgba(0,0,0,0.6);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; }
        
        body {
            font-family: var(--font-main);
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            overscroll-behavior: none;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* --- Header --- */
        .header {
            text-align: center;
            margin-bottom: 25px;
            animation: fadeInDown 0.8s ease;
        }
        .header h1 { 
            font-size: 2.8rem; 
            background: linear-gradient(to right, #818cf8, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px; 
            font-weight: 800;
        }
        .header p { color: var(--text-muted); font-size: 1rem; letter-spacing: 1px; }

        /* --- Card Container --- */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            border: 1px solid var(--glass-border);
            position: relative;
        }

        /* --- Buttons --- */
        .btn {
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: white;
            user-select: none;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .btn-outline { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-muted); }
        .btn-outline:hover { background: rgba(255,255,255,0.1); color: white; border-color: var(--text-main); }
        .btn-restart { background: rgba(56, 189, 248, 0.15); color: var(--accent); border: 1px solid rgba(56, 189, 248, 0.3); }
        .btn-restart:hover { background: rgba(56, 189, 248, 0.25); }

        /* --- Grid Menu --- */
        .game-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            width: 100%;
        }
        .game-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
            display: flex; flex-direction: column; justify-content: space-between;
            width: 160px;
            height: 180px; 
        }
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.08);
            border-color: var(--primary);
        }
        .game-icon { font-size: 2.5rem; margin-bottom: 10px; display: block; filter: drop-shadow(0 0 8px rgba(255,255,255,0.1)); }
        .game-title { font-size: 1.1rem; margin-bottom: 5px; color: var(--text-main); font-weight: 700; }
        .game-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px; line-height: 1.2; }

        /* --- Views --- */
        .view { display: none; animation: fadeIn 0.4s ease; width: 100%; }
        .view.active { display: block; }

        /* --- Game Controls --- */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .controls-left, .controls-right { display: flex; gap: 10px; align-items: center; }

        .stats-bar {
            background: rgba(15, 23, 42, 0.6);
            padding: 8px 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.1rem;
            border: 1px solid var(--glass-border);
            color: var(--accent);
            min-width: 90px; text-align: center;
        }
        
        /* Animaci√≥n para bonus de tiempo */
        .time-bonus { animation: flashGreen 0.5s ease; color: var(--success) !important; }
        .time-penalty { animation: flashRed 0.5s ease; color: var(--danger) !important; }

        .difficulty-selector select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: #1e293b;
            color: white;
            cursor: pointer;
            outline: none;
            font-size: 0.9rem;
        }

        #game-board-area {
            min-height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 10px;
            user-select: none;
        }

        /* --- GAME SPECIFIC STYLES --- */
        
        /* Memory */
        .memory-grid { display: grid; gap: 8px; perspective: 1000px; margin: 0 auto; }
        .memory-card {
            width: 60px; height: 60px; position: relative;
            transform-style: preserve-3d; transition: transform 0.4s; cursor: pointer;
        }
        .memory-card.flip { transform: rotateY(180deg); }
        .front, .back {
            width: 100%; height: 100%; position: absolute;
            backface-visibility: hidden; border-radius: 10px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .front { background: #1e293b; transform: rotateY(180deg); border: 1px solid var(--glass-border); font-size: 1.8rem; }
        .back { background: linear-gradient(135deg, #334155, #475569); border: 1px solid rgba(255,255,255,0.1); }

        /* Sudoku */
        .sudoku-grid {
            display: grid; grid-template-columns: repeat(9, 1fr); gap: 1px;
            background: #475569; border: 2px solid #475569; max-width: 400px; width: 100%;
            border-radius: 4px; overflow: hidden;
        }
        .sudoku-cell {
            background: #1e293b; aspect-ratio: 1; display: flex; justify-content: center; align-items: center;
            font-size: 1.1rem; cursor: pointer; color: var(--text-main);
        }
        .sudoku-cell.initial { font-weight: bold; color: var(--highlight); background: #0f172a; }
        .sudoku-cell.selected { background: rgba(99, 102, 241, 0.4); }
        .sudoku-cell.error { color: var(--danger); background: rgba(244, 63, 94, 0.2); }
        .sudoku-cell:nth-child(3n) { border-right: 2px solid #64748b; } .sudoku-cell:nth-child(9n) { border-right: none; }
        .sudoku-grid .sudoku-cell:nth-child(n+19):nth-child(-n+27), .sudoku-grid .sudoku-cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 2px solid #64748b; }
        .numpad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 20px; max-width: 400px; width: 100%; }
        .numpad button { background: rgba(255,255,255,0.1); color: white; border: none; font-size: 1.1rem; padding: 10px; border-radius: 8px; cursor: pointer; }

        /* Word Search */
        .ws-grid { display: grid; gap: 2px; background: #334155; padding: 3px; border-radius: 8px; touch-action: none; }
        .ws-cell {
            background: #1e293b; width: 28px; height: 28px; display: flex; justify-content: center; align-items: center;
            font-weight: 600; cursor: pointer; font-size: 0.8rem; color: #cbd5e1;
        }
        .ws-cell.selected { background: var(--highlight); color: #0f172a; } .ws-cell.found { background: var(--success); color: #0f172a; }
        .ws-word { padding: 4px 8px; background: rgba(255,255,255,0.1); border-radius: 12px; font-size: 0.8rem; color: var(--text-muted); display: inline-block; margin: 2px; }
        .ws-word.done { text-decoration: line-through; color: var(--success); opacity: 0.5; }

        /* Stroop & Math */
        .choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .choice-btn { font-size: 1.3rem; padding: 15px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 12px; }
        .stroop-word { font-size: 3.5rem; font-weight: 900; margin: 20px 0; text-shadow: 0 0 20px rgba(0,0,0,0.5); letter-spacing: 2px; }

        /* 2048 Game */
        .g2048-container {
            background: #0f172a; padding: 10px; border-radius: 12px; touch-action: none;
            display: grid; gap: 8px; position: relative; user-select: none;
            border: 2px solid var(--glass-border);
        }
        .g2048-cell {
            background: rgba(255,255,255,0.05); border-radius: 8px; width: 70px; height: 70px;
            display: flex; justify-content: center; align-items: center;
            font-size: 2rem; font-weight: 800; color: white;
            transition: all 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        .tile-2 { background: #6366f1; box-shadow: 0 4px 0 #4338ca; border: 1px solid rgba(255,255,255,0.2); }
        .tile-4 { background: #38bdf8; box-shadow: 0 4px 0 #0284c7; border: 1px solid rgba(255,255,255,0.2); }
        .tile-8 { background: #22c55e; box-shadow: 0 4px 0 #15803d; border: 1px solid rgba(255,255,255,0.2); }
        .tile-16 { background: #fbbf24; box-shadow: 0 4px 0 #b45309; border: 1px solid rgba(255,255,255,0.2); }
        .tile-32 { background: #f472b6; box-shadow: 0 4px 0 #be185d; }
        .tile-64 { background: #ef4444; box-shadow: 0 4px 0 #b91c1c; }
        .tile-128 { background: #a855f7; box-shadow: 0 0 15px #a855f7; z-index: 2; }
        .tile-256 { background: #3b82f6; box-shadow: 0 0 20px #3b82f6; z-index: 2; }
        .tile-512 { background: #ec4899; box-shadow: 0 0 25px #ec4899; z-index: 2; }
        .tile-1024 { background: #eab308; box-shadow: 0 0 30px #eab308; font-size: 1.6rem; z-index: 2; }

        /* Anagram Game */
        .anagram-pool { display: flex; gap: 8px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .anagram-slots { display: flex; gap: 8px; justify-content: center; margin-bottom: 20px; min-height: 50px; }
        .letter-btn {
            width: 45px; height: 45px; border-radius: 8px; font-size: 1.5rem; font-weight: bold;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: white;
        }
        .letter-btn.empty { background: rgba(0,0,0,0.2); border: 2px dashed rgba(255,255,255,0.1); cursor: default; }
        .letter-btn:active { transform: scale(0.9); background: var(--primary); }

        /* Diff Game */
        .diff-cell { background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 1.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; aspect-ratio: 1; }
        .diff-cell:active { transform: scale(0.9); }

        /* --- Modals --- */
        #confetti-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 1000; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #1e293b; padding: 30px; border-radius: 20px;
            max-width: 380px; width: 90%; text-align: center;
            border: 1px solid var(--glass-border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal h2 { color: var(--primary); margin-bottom: 10px; font-size: 1.8rem; }
        .modal input {
            width: 100%; padding: 12px; margin: 10px 0 20px 0;
            border: 1px solid #334155; border-radius: 10px;
            font-size: 1.1rem; background: #0f172a; color: white; text-align: center;
        }
        #ranking-list { max-height: 350px; overflow-y: auto; text-align: left; }
        #ranking-list li { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; display: flex; justify-content: space-between; }
        #ranking-list b { color: var(--accent); }

        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes flashGreen { 0% { background: rgba(16, 185, 129, 0); } 50% { background: rgba(16, 185, 129, 0.3); } 100% { background: transparent; } }
        @keyframes flashRed { 0% { background: rgba(244, 63, 94, 0); } 50% { background: rgba(244, 63, 94, 0.3); } 100% { background: transparent; } }

        @media (max-width: 600px) {
            .header h1 { font-size: 2rem; }
            .g2048-cell { width: 55px; height: 55px; font-size: 1.4rem; }
            .memory-card { width: 50px; height: 50px; }
            .ws-cell { width: 24px; height: 24px; font-size: 0.7rem; }
            .stroop-word { font-size: 2.5rem; }
            .controls-left, .controls-right { width: 100%; justify-content: center; margin-bottom: 5px; }
            .game-grid { gap: 10px; }
            .game-card { width: 45%; } 
        }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div class="container">
        <header class="header">
            <h1>üß† Brain Buddy</h1>
            <p>Arcade Edition</p>
        </header>

        <div id="view-menu" class="view active">
            <div class="game-grid">
                </div>
            <div style="margin-top: 40px; text-align: center; width: 100%;">
                 <button class="btn btn-outline" onclick="App.showRankingGlobal()">üèÜ Ver R√©cords</button>
            </div>
        </div>

        <div id="view-game" class="view">
            <div class="card">
                <div class="game-header">
                    <div class="controls-left">
                        <button class="btn btn-outline" onclick="App.confirmExit()">‚¨Ö Men√∫</button>
                        <div class="difficulty-selector">
                            <select id="difficulty-select" onchange="App.changeDifficulty(this.value)">
                                <option value="easy">F√°cil</option>
                                <option value="medium">Medio</option>
                                <option value="hard">Dif√≠cil</option>
                                <option value="extreme">Extremo</option>
                            </select>
                        </div>
                    </div>
                    <div class="controls-right">
                        <div class="stats-bar">
                            <span id="stat-1">30s</span>
                        </div>
                        <span id="stat-2" style="font-weight:bold; color:var(--highlight)"></span>
                        <button class="btn btn-restart" onclick="App.restartGame()" title="Reiniciar Juego">‚Üª Reiniciar</button>
                    </div>
                </div>
                
                <div id="game-title-display" style="text-align: center; margin-bottom: 20px; color: var(--primary); font-size: 1.5rem; font-weight: 700; letter-spacing: 1px;"></div>
                
                <div id="game-board-area">
                    </div>
            </div>
        </div>
    </div>

    <div id="modal-win" class="modal-overlay">
        <div class="modal">
            <h2>üéâ ¬°Fin del Juego!</h2>
            <p id="win-message">Resultados.</p>
            <div id="record-section" style="display:none; margin-top:15px;">
                <p style="color: var(--success); font-weight: bold; margin-bottom: 5px;">¬°NUEVO R√âCORD!</p>
                <input type="text" id="player-name" placeholder="Tu nombre..." maxlength="12" autocomplete="off">
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="App.handleWinAction('replay')">‚Üª Jugar de nuevo</button>
                <button class="btn btn-outline" onclick="App.handleWinAction('exit')">‚ûú Salir</button>
            </div>
        </div>
    </div>

    <div id="modal-ranking" class="modal-overlay">
        <div class="modal">
            <h2>üèÜ R√©cords</h2>
            <div id="ranking-list"></div>
            <button class="btn btn-primary" style="margin-top:15px; width:100%" onclick="document.getElementById('modal-ranking').classList.remove('active')">Cerrar</button>
        </div>
    </div>

<script>
/**
 * BRAIN BUDDY ARCADE
 */

const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

const Sound = {
    ctx: new (window.AudioContext || window.webkitAudioContext)(),
    play: function(freq, type, dur, vol=0.1) {
        if(this.ctx.state === 'suspended') this.ctx.resume();
        const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
        o.type = type; o.frequency.value = freq;
        g.gain.setValueAtTime(vol, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime + dur);
    },
    win: () => { Sound.play(400,'sine',0.1); setTimeout(()=>Sound.play(600,'sine',0.1),100); setTimeout(()=>Sound.play(800,'triangle',0.4,0.2),200); },
    click: () => Sound.play(300,'sine',0.05,0.05),
    error: () => Sound.play(150,'sawtooth',0.3,0.08),
    merge: () => Sound.play(500,'square',0.05,0.05)
};

const Storage = {
    get: () => JSON.parse(localStorage.getItem('brainBuddy_v9')) || {},
    save: (d) => localStorage.setItem('brainBuddy_v9', JSON.stringify(d)),
    check: (id, diff, score, mode) => {
        const d = Storage.get();
        const cur = d[`${id}_${diff}`];
        if(!cur) return true;
        // If mode is 'score', Higher is better. Else 'time', Lower is better.
        if (mode === 'score') return score > cur.score;
        return score < cur.score;
    },
    set: (id, diff, name, score) => {
        const d = Storage.get();
        d[`${id}_${diff}`] = { name, score, date: new Date().toLocaleDateString() };
        Storage.save(d);
    }
};

const Confetti = {
    canvas: document.getElementById('confetti-canvas'),
    ctx: document.getElementById('confetti-canvas').getContext('2d'),
    particles: [], active: false,
    resize: function() { this.canvas.width=window.innerWidth; this.canvas.height=window.innerHeight; },
    start: function() {
        this.resize(); this.particles=[];
        const colors = ['#6366f1', '#a855f7', '#38bdf8', '#10b981', '#fbbf24'];
        for(let i=0; i<100; i++) this.particles.push({
            x: Math.random()*this.canvas.width, y: Math.random()*this.canvas.height-this.canvas.height,
            c: colors[Math.floor(Math.random()*colors.length)],
            vx: Math.random()*2-1, vy: Math.random()*3+2, s: Math.random()*8+4
        });
        this.active=true; this.loop();
        setTimeout(()=>this.stop(), 3000);
    },
    stop: function() { this.active=false; this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height); },
    loop: function() {
        if(!this.active) return;
        this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
        this.particles.forEach(p=>{
            p.y+=p.vy; p.x+=p.vx;
            this.ctx.fillStyle=p.c; this.ctx.fillRect(p.x,p.y,p.s,p.s);
            if(p.y>this.canvas.height) p.y=-10;
        });
        requestAnimationFrame(()=>this.loop());
    }
};

// --- GAMES ---

// 1. Memory Game
class MemoryGame {
    constructor(diff) {
        this.diff = diff;
        this.cards = []; this.flipped = []; this.locked = false; this.matched = 0;
        this.streak = 0;
        
        if (diff === 'easy') { this.cols = 4; this.rows = 4; }
        else if (diff === 'medium') { this.cols = 5; this.rows = 4; }
        else { this.cols = 6; this.rows = 6; }
        
        const themes = {
            faces: ['üòÄ','üòÇ','üòç','üòé','ü§¨','ü§¢','ü§°','üëª','üëΩ','ü§ñ','üí©','üë∫','üíÄ','ü§ï','ü§†','ü•∏','üòá','üéÉ'],
            transport: ['üöÄ','üöó','üöì','üöë','üöí','üö≤','üõµ','üöÇ','‚úàÔ∏è','üõ∏','üöÅ','üõ∂','‚õµ','üö§','üöú','üöõ','üöå','üèéÔ∏è'],
            sports: ['‚öΩ','üèÄ','üèà','‚öæ','üéæ','üèê','üèâ','üé±','üèì','üè∏','ü•Ö','ü•ä','ü•ã','‚õ≥','‚õ∏','üé£','ü§ø','üèÑ'],
            fruits: ['üçè','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','ü´ê','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','ü•ë']
        };

        const totalPairs = (this.cols * this.rows) / 2;
        let pool = [];

        if (diff === 'extreme') {
            const all = [...themes.faces, ...themes.transport, ...themes.sports, ...themes.fruits];
            pool = all.sort(() => 0.5 - Math.random()).slice(0, totalPairs);
        } else {
            const keys = Object.keys(themes);
            const key = keys[Math.floor(Math.random() * keys.length)];
            pool = themes[key].sort(() => 0.5 - Math.random()).slice(0, totalPairs);
        }
        this.cards = [...pool, ...pool].sort(() => 0.5 - Math.random());
    }
    init(c) {
        c.innerHTML = `<div class="memory-grid" style="grid-template-columns: repeat(${this.cols}, 1fr);">
            ${this.cards.map((e, i) => `<div class="memory-card" onclick="App.curr.flip(${i})" id="c-${i}"><div class="front">${e}</div><div class="back"></div></div>`).join('')}</div>`;
    }
    flip(i) {
        const card = $(`#c-${i}`);
        if (this.locked || card.classList.contains('flip') || this.flipped.some(c=>c.id===i)) return;
        card.classList.add('flip'); Sound.click(); this.flipped.push({ id: i, val: this.cards[i], el: card });
        if (this.flipped.length === 2) {
            this.locked = true; App.moves++; $('#stat-2').textContent = `Mov: ${App.moves}`;
            if (this.flipped[0].val === this.flipped[1].val) {
                this.matched++; this.flipped = []; this.locked = false; 
                this.streak++;
                if (this.streak >= 2) {
                    App.addTime(5, false);
                    this.streak = 0;
                }
                if (this.matched === this.cards.length / 2) App.endGame(true);
            } else {
                this.streak = 0;
                Sound.error(); setTimeout(() => { this.flipped.forEach(c => c.el.classList.remove('flip')); this.flipped = []; this.locked = false; }, 800);
            }
        }
    }
}

// 2. Math
class MathGame {
    constructor(diff) { 
        this.diff=diff; this.score=0; this.combo=0; 
        this.bonus = diff==='easy'?2:(diff==='medium'?3:5);
    }
    init(c) { c.innerHTML=`<div style="text-align:center"><div class="math-problem" id="mt-p"></div><div class="choice-grid" id="mt-o"></div></div>`; this.next(); }
    next() {
        const ops=['+','-','*']; let op=ops[Math.floor(Math.random()*(this.diff==='easy'?2:3))];
        let a,b,res,lim=this.diff==='easy'?10:50;
        if(op==='*'){ a=Math.floor(Math.random()*10)+2; b=Math.floor(Math.random()*10)+2; res=a*b; }
        else { a=Math.floor(Math.random()*lim)+1; b=Math.floor(Math.random()*lim)+1; if(op==='-'){if(a<b)[a,b]=[b,a]; res=a-b;} else res=a+b; }
        $('#mt-p').textContent=`${a} ${op} ${b} = ?`; $('#stat-2').textContent=`Pts: ${this.score}`;
        let o=[res]; while(o.length<4){ let f=res+(Math.floor(Math.random()*20)-10); if(f>=0 && !o.includes(f)) o.push(f); }
        $('#mt-o').innerHTML=o.sort(()=>0.5-Math.random()).map(v=>`<button class="btn choice-btn" onclick="App.curr.ans(${v},${res})">${v}</button>`).join('');
    }
    ans(v,r) { 
        if(v===r){
            this.score+=10; this.combo++; Sound.click(); 
            if(this.combo % 3 === 0) App.addTime(this.bonus, true); 
            this.next();
        } else {
            this.score = Math.max(0, this.score-5); this.combo=0; Sound.error(); App.visualPenalty(); this.next();
        } 
    }
}

// 3. Anagram (Updated with Large Dictionary & No Repeats)
class AnagramGame {
    constructor(diff) {
        this.diff = diff; this.score = 0; this.combo = 0;
        this.bonus = diff==='easy'?2:(diff==='medium'?3:5);
        this.len = diff==='easy'?4:(diff==='medium'?5:(diff==='hard'?6:8));
        
        // Expanded Dictionary
        const easyWords = [
            'SOL', 'MAR', 'LUZ', 'PAN', 'OJO', 'SAL', 'OLA', 'ORO', 'RIO', 'SUR', 'DOS', 'TREN', 'FLOR', 'PIE', 'UVA', 'VOS', 'TIA',
            'GATO', 'PATO', 'LUNA', 'CASA', 'AGUA', 'ROJO', 'MESA', 'MANO', 'BOCA', 
            'CARA', 'NUBE', 'AIRE', 'VIDA', 'AMOR', 'RISA', 'BESO', 'HOJA', 'LAGO', 
            'COPA', 'CAJA', 'BOLA', 'LEON', 'LOBO', 'MONO', 'VACA', 'PISO', 'TORO', 
            'DADO', 'ROPA', 'TELA', 'VINO', 'AZUL', 'ARCO', 'DEDO', 'PINT', 'PELO'
        ];
        
        const medWords = ['ARBOL','PERRO','LIBRO','PLAYA','NORTE','QUESO','VERDE','RELOJ','FUEGO','NIEVE','LAPIZ','SILLA','PIZZA','RADIO','COCHE'];
        const hardWords = ['PLANETA','MUSICA','DOCTOR','CODIGO','FUTURO','JARDIN','ESPACIO','GUITARRA','PROGRAMA','SILENCIO','ELEFANTE','EDIFICIO'];
        
        this.words = diff==='easy' ? easyWords : (diff==='medium' ? medWords : hardWords);
        
        this.target = []; // Stack for unique selection
        this.curWord=''; this.pool=[]; this.slots=[];
    }
    init(c) {
        this.cont = c; this.load();
        
        document.onkeydown = (e) => {
            const key = e.key.toUpperCase();
            if (key === 'BACKSPACE') {
                const lastIdx = this.slots.map((s, i) => s ? i : -1).filter(i => i !== -1).pop();
                if (lastIdx !== undefined) this.clkSlot(lastIdx);
            } else if (key.length === 1 && key.match(/[A-Z√ë]/)) {
                const found = this.pool.find(p => p.l === key);
                if (found) this.clkPool(found.id);
            }
        };
    }
    load() {
        // Refill pool if empty
        if(this.target.length === 0) {
            this.target = [...this.words].sort(() => 0.5 - Math.random());
        }
        
        // Pop word to ensure no repeats until full cycle
        this.curWord = this.target.pop();
        
        this.pool = this.curWord.split('').sort(()=>0.5-Math.random()).map((l,i)=>({l, id:i}));
        this.slots = Array(this.curWord.length).fill(null);
        this.render();
    }
    render() {
        $('#stat-2').textContent = `Pts: ${this.score}`;
        this.cont.innerHTML = `
            <div style="text-align:center; margin-bottom:20px">Ordena las letras:</div>
            <div class="anagram-slots">
                ${this.slots.map((s,i)=> s ? `<div class="letter-btn" onclick="App.curr.clkSlot(${i})">${s.l}</div>` : `<div class="letter-btn empty"></div>`).join('')}
            </div>
            <div class="anagram-pool">
                ${this.pool.map(p=> `<div class="letter-btn" onclick="App.curr.clkPool(${p.id})">${p.l}</div>`).join('')}
            </div>
        `;
    }
    clkPool(id) {
        const pIdx = this.pool.findIndex(p=>p.id===id);
        const sIdx = this.slots.findIndex(s=>s===null);
        if(pIdx>-1 && sIdx>-1) {
            this.slots[sIdx] = this.pool[pIdx];
            this.pool.splice(pIdx,1);
            Sound.click(); this.render(); this.check();
        }
    }
    clkSlot(i) {
        if(this.slots[i]) {
            this.pool.push(this.slots[i]);
            this.slots[i] = null;
            Sound.click(); this.render();
        }
    }
    check() {
        if(!this.slots.includes(null)) {
            const w = this.slots.map(s=>s.l).join('');
            if(w === this.curWord) {
                Sound.merge(); 
                this.score += 10;
                this.combo++;
                if(this.combo % 3 === 0) App.addTime(this.bonus, true);
                setTimeout(()=>{ this.load(); }, 300);
            } else {
                Sound.error();
                this.score = Math.max(0, this.score-5);
                this.combo = 0;
                App.visualPenalty();
                this.pool = this.curWord.split('').sort(()=>0.5-Math.random()).map((l,i)=>({l, id:i}));
                this.slots = Array(this.curWord.length).fill(null);
                setTimeout(()=>this.render(), 300);
            }
        }
    }
}

// 4. Sudoku
class Sudoku {
    constructor(diff) { this.diff = diff; this.board = []; this.sol = []; }
    init(c) {
        c.innerHTML = `<div class="sudoku-grid" id="sdk-b"></div><div class="numpad" id="sdk-p"></div>`;
        this.gen();
        const b = $('#sdk-b');
        this.board.forEach((r, i) => r.forEach((v, j) => {
            const d = document.createElement('div'); d.className = `sudoku-cell ${v?'initial':''}`; d.textContent = v||'';
            d.onclick = () => { if(!v) this.sel(d, i, j); }; b.appendChild(d);
        }));
        [1,2,3,4,5,6,7,8,9,'‚å´'].forEach(n=>{
            const btn=document.createElement('button'); btn.textContent=n; btn.onclick=()=>this.inp(n); $('#sdk-p').appendChild(btn);
        });
    }
    sel(el, r, c) { $$('.selected').forEach(x=>x.classList.remove('selected')); this.cur = { el, r, c }; el.classList.add('selected'); }
    inp(v) {
        if (!this.cur) return;
        if (v==='‚å´') { this.cur.el.textContent=''; this.board[this.cur.r][this.cur.c]=0; return; }
        this.cur.el.textContent=v; this.board[this.cur.r][this.cur.c]=v;
        if (v!=this.sol[this.cur.r][this.cur.c]) { this.cur.el.classList.add('error'); Sound.error(); }
        else { this.cur.el.classList.remove('error'); Sound.click(); if (this.check()) App.endGame(true); }
    }
    check() { return this.board.every((r,i)=>r.every((c,j)=>c===this.sol[i][j])); }
    gen() {
        this.sol = Array(9).fill().map(()=>Array(9).fill(0));
        const fill=(r,c)=>{
            const n=[1,2,3,4,5,6,7,8,9].sort(()=>0.5-Math.random());
            for(let x of n) if(this.valid(r,c,x)){ this.sol[r][c]=x; if(c===8?(r===8?true:fill(r+1,0)):fill(r,c+1)) return true; this.sol[r][c]=0; }
            return false;
        }; fill(0,0);
        this.board=JSON.parse(JSON.stringify(this.sol));
        let rem = this.diff==='easy'?30:(this.diff==='medium'?40:(this.diff==='hard'?50:58));
        while(rem>0){ let r=Math.floor(Math.random()*9),c=Math.floor(Math.random()*9); if(this.board[r][c]!==0){this.board[r][c]=0;rem--;} }
    }
    valid(r,c,v){
        for(let k=0;k<9;k++) if(this.sol[r][k]===v || this.sol[k][c]===v) return false;
        let br=Math.floor(r/3)*3, bc=Math.floor(c/3)*3;
        for(let i=0;i<3;i++) for(let j=0;j<3;j++) if(this.sol[br+i][bc+j]===v) return false;
        return true;
    }
}

// 5. Word Search
class WordSearch {
    constructor(diff) {
        this.diff=diff; this.sz=diff==='easy'?8:(diff==='medium'?10:12);
        this.words=["JAVA","HTML","CSS","NODE","WIFI","DATA","CODE","BYTE","LINK","PING"];
        this.target=this.words.sort(()=>0.5-Math.random()).slice(0,Math.floor(this.sz*0.6)); this.found=0;
    }
    init(c) {
        c.innerHTML=`<div style="margin-bottom:10px;text-align:center">Palabras: <span id="ws-c" style="color:var(--highlight)">0</span>/${this.target.length}</div>
        <div class="ws-grid" style="grid-template-columns:repeat(${this.sz},1fr);max-width:${this.sz*28}px;margin:0 auto;" id="ws-b"></div>
        <div style="text-align:center;margin-top:15px">${this.target.map(w=>`<span class="ws-word" id="wd-${w}">${w}</span>`).join('')}</div>`;
        this.gen(); const b=$('#ws-b');
        this.grid.forEach((r,i)=>r.forEach((l,j)=>{
            const d=document.createElement('div');d.className='ws-cell';d.textContent=l;d.dataset.r=i;d.dataset.c=j;b.appendChild(d);
        })); this.evt(b);
    }
    gen() {
        this.grid=Array(this.sz).fill().map(()=>Array(this.sz).fill(''));
        this.target.forEach(w=>{
            let p=false,t=0,wp=w;
            if((this.diff==='hard'||this.diff==='extreme')&&Math.random()>0.5) wp=w.split('').reverse().join('');
            while(!p && t<100){
                const d=Math.floor(Math.random()*3), r=Math.floor(Math.random()*this.sz), c=Math.floor(Math.random()*this.sz);
                if(this.can(wp,r,c,d)){this.put(wp,r,c,d);p=true;}t++;
            }
        });
        const abc="ABCDEFGHIJKLMN√ëOPQRSTUVWXYZ"; for(let r=0;r<this.sz;r++)for(let c=0;c<this.sz;c++)if(!this.grid[r][c])this.grid[r][c]=abc[Math.floor(Math.random()*abc.length)];
    }
    can(w,r,c,d){
        if((d===0&&c+w.length>this.sz)||(d===1&&r+w.length>this.sz)||(d===2&&(c+w.length>this.sz||r+w.length>this.sz)))return false;
        for(let i=0;i<w.length;i++) if(this.grid[r+(d>0?i:0)][c+(d!==1?i:0)] && this.grid[r+(d>0?i:0)][c+(d!==1?i:0)]!==w[i]) return false;
        return true;
    }
    put(w,r,c,d){for(let i=0;i<w.length;i++)this.grid[r+(d>0?i:0)][c+(d!==1?i:0)]=w[i];}
    evt(b){
        let s=false,st=null,cs=[];
        const get=(e)=> (e.target.closest('.ws-cell')||(e.touches?document.elementFromPoint(e.touches[0].clientX,e.touches[0].clientY)?.closest('.ws-cell'):null));
        const up=(e)=>{
            if(s){s=false;$$('.ws-cell.selected').forEach(x=>x.classList.remove('selected'));
            const txt=cs.map(p=>this.grid[p.r][p.c]).join(''), rev=txt.split('').reverse().join('');
            const m=this.target.includes(txt)?txt:(this.target.includes(rev)?rev:null);
            if(m){
                const el=$(`#wd-${m}`); if(!el.classList.contains('done')){
                    el.classList.add('done');this.found++;$('#ws-c').textContent=this.found;
                    cs.forEach(p=>$(`.ws-cell[data-r="${p.r}"][data-c="${p.c}"]`).classList.add('found'));
                    Sound.click(); if(this.found===this.target.length)App.endGame(true);
                }
            }}
        };
        const mv=(e)=>{ if(s){ const c=get(e); if(c){
            $$('.ws-cell.selected').forEach(x=>x.classList.remove('selected'));
            const en={r:+c.dataset.r,c:+c.dataset.c}, dr=en.r-st.r, dc=en.c-st.c; cs=[];
            if(!dr||!dc||Math.abs(dr)===Math.abs(dc)){
                const stp=Math.max(Math.abs(dr),Math.abs(dc)), sr=dr?dr/Math.abs(dr):0, sc=dc?dc/Math.abs(dc):0;
                for(let i=0;i<=stp;i++) cs.push({r:st.r+i*sr,c:st.c+i*sc});
                cs.forEach(p=>$(`.ws-cell[data-r="${p.r}"][data-c="${p.c}"]`)?.classList.add('selected'));
            }
        }}};
        const dn=(e)=>{const c=get(e);if(c){s=true;st={r:+c.dataset.r,c:+c.dataset.c};}};
        b.onmousedown=dn;b.onmousemove=mv;document.onmouseup=up; b.ontouchstart=dn;b.ontouchmove=mv;document.ontouchend=up;
    }
}

// 6. Diff Game
class DiffGame {
    constructor(diff) { this.lvl=1; this.max=diff==='easy'?3:5; }
    init(c) { this.c=c; this.load(); }
    load() {
        const sz=Math.min(this.lvl+3,7), em=['üòÄ','üòé','ü§©','ü•∂','ü§¢','üë∫','üíÄ','üëΩ','ü§ñ','üéÉ'], b=em[Math.floor(Math.random()*em.length)];
        let d; do{d=em[Math.floor(Math.random()*em.length)];}while(d===b);
        this.c.innerHTML=`<div style="text-align:center;margin-bottom:15px">Nivel ${this.lvl} / ${this.max}</div>
        <div class="diff-grid" style="display:grid;grid-template-columns:repeat(${sz},1fr);gap:6px;max-width:400px;margin:0 auto;"></div>`;
        const g=$('.diff-grid'), t=Math.floor(Math.random()*(sz*sz));
        for(let i=0;i<sz*sz;i++){
            const el=document.createElement('div'); el.className='diff-cell'; el.textContent=i===t?d:b;
            el.onclick=()=>{if(i===t){Sound.click();this.lvl++;if(this.lvl>this.max)App.endGame(true);else this.load();}else Sound.error();};
            g.appendChild(el);
        }
    }
}

// 7. Stroop
class StroopGame {
    constructor(diff) { this.sc=0; this.max=diff==='easy'?10:15; this.cols=[{n:'ROJO',h:'#ef4444'},{n:'AZUL',h:'#3b82f6'},{n:'VERDE',h:'#22c55e'},{n:'AMARILLO',h:'#eab308'}]; }
    init(c) { c.innerHTML=`<div style="text-align:center"><div class="stroop-question" id="st-q"></div><div class="stroop-word" id="st-w"></div><div class="choice-grid" id="st-o"></div></div>`; this.next(); }
    next() {
        const t=this.cols[Math.floor(Math.random()*4)]; let c; do{c=this.cols[Math.floor(Math.random()*4)];}while(c.n===t.n);
        const m=(Math.random()>0.5)?'col':'txt', q=m==='col'?'¬øQu√© <b>COLOR</b> ves?':'¬øQu√© <b>DICE</b>?';
        $('#st-q').innerHTML=q; const w=$('#st-w'); w.textContent=t.n; w.style.color=c.h; $('#stat-2').textContent=`Pts: ${this.sc}/${this.max}`;
        let o=[m==='col'?c.n:t.n]; while(o.length<4){const r=this.cols[Math.floor(Math.random()*4)].n; if(!o.includes(r))o.push(r);}
        $('#st-o').innerHTML=o.sort(()=>0.5-Math.random()).map(v=>`<button class="btn choice-btn" onclick="App.curr.ans('${v}','${o[0]}')">${v}</button>`).join('');
    }
    ans(v,r){ if(v===r){this.sc++;Sound.click();if(this.sc>=this.max)App.endGame(true);else this.next();}else{Sound.error();this.next();} }
}

// 8. 2048
class Game2048 {
    constructor(diff) {
        this.sz=diff==='easy'?5:4; this.grid=[]; this.score=0;
        this.winTile=diff==='easy'?128:(diff==='medium'?256:(diff==='hard'?512:1024));
    }
    init(c) {
        c.innerHTML=`<div style="text-align:center;margin-bottom:10px">Meta: <span style="color:var(--highlight);font-weight:bold">${this.winTile}</span></div>
        <div class="g2048-container" style="grid-template-columns:repeat(${this.sz},1fr);width:${this.sz*78}px;margin:0 auto;" id="g2048"></div>`;
        this.grid=Array(this.sz*this.sz).fill(0); this.spawn(); this.spawn(); this.render();
        document.onkeydown=(e)=>{
            if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){ e.preventDefault(); this.move(e.key.replace('Arrow','').toLowerCase()); }
        };
        const b=$('#g2048'); let tsX, tsY; let mDown=false;
        b.ontouchstart=(e)=>{tsX=e.touches[0].clientX; tsY=e.touches[0].clientY; e.preventDefault();};
        b.ontouchend=(e)=>{
            const dx=e.changedTouches[0].clientX-tsX, dy=e.changedTouches[0].clientY-tsY;
            this.handleSwipe(dx, dy);
        };
        b.onmousedown=(e)=>{ mDown=true; tsX=e.clientX; tsY=e.clientY; };
        document.onmouseup=(e)=>{
            if(!mDown) return; mDown=false;
            const dx=e.clientX-tsX, dy=e.clientY-tsY;
            this.handleSwipe(dx, dy);
        };
    }
    handleSwipe(dx, dy) {
        if(Math.abs(dx)>Math.abs(dy)){ if(Math.abs(dx)>30) this.move(dx>0?'right':'left'); }
        else { if(Math.abs(dy)>30) this.move(dy>0?'down':'up'); }
    }
    render() {
        const b=$('#g2048'); b.innerHTML='';
        this.grid.forEach(v=>{
            const d=document.createElement('div'); d.className=`g2048-cell tile-${v}`; d.textContent=v||''; b.appendChild(d);
        });
    }
    spawn() {
        const emp=this.grid.map((v,i)=>v===0?i:null).filter(v=>v!==null);
        if(emp.length){ this.grid[emp[Math.floor(Math.random()*emp.length)]] = Math.random()>0.9?4:2; }
    }
    move(dir) {
        let moved=false; const sz=this.sz;
        const getLine=(i, isRow)=> { let l=[]; for(let k=0;k<sz;k++) l.push(this.grid[isRow ? i*sz+k : k*sz+i]); return l; };
        const setLine=(i, l, isRow)=> { for(let k=0;k<sz;k++) this.grid[isRow ? i*sz+k : k*sz+i] = l[k]; };
        const merge=(row)=> {
            let arr=row.filter(v=>v); if(dir==='right'||dir==='down') arr.reverse();
            for(let i=0;i<arr.length-1;i++){ if(arr[i]===arr[i+1]){ arr[i]*=2; arr[i+1]=0; Sound.merge(); if(arr[i]===this.winTile) setTimeout(()=>App.endGame(true),300); } }
            arr=arr.filter(v=>v); while(arr.length<sz) arr.push(0); if(dir==='right'||dir==='down') arr.reverse(); return arr;
        };
        for(let i=0;i<sz;i++){
            const old=getLine(i, dir==='left'||dir==='right'); const nw=merge(old);
            setLine(i, nw, dir==='left'||dir==='right'); if(old.some((v,k)=>v!==nw[k])) moved=true;
        }
        if(moved){ this.spawn(); this.render(); }
    }
}


// --- CONTROLLER ---

const App = {
    curr: null, type: null, diff: 'easy', time: 0, timer: null, moves: 0,
    list: [
        { id:'mem', t:'Memoria', i:'üß©', d:'Parejas', c:MemoryGame, mode:'time' },
        { id:'mat', t:'C√°lculo', i:'‚úñÔ∏è', d:'Arcade', c:MathGame, mode:'score' },
        { id:'ana', t:'Anagrama', i:'üî°', d:'Arcade', c:AnagramGame, mode:'score' },
        { id:'sud', t:'Sudoku', i:'üî¢', d:'L√≥gica', c:Sudoku, mode:'time' },
        { id:'wrd', t:'Sopa Letras', i:'üîé', d:'Buscar', c:WordSearch, mode:'time' },
        { id:'dif', t:'Intruso', i:'üßê', d:'Visual', c:DiffGame, mode:'time' },
        { id:'str', t:'Confusi√≥n', i:'üé®', d:'Stroop', c:StroopGame, mode:'time' }, // Stroop remains as rounds
        { id:'2048', t:'2048', i:'üßä', d:'Desliza', c:Game2048, mode:'time' }
    ],

    init: () => {
        const g = $('.game-grid');
        App.list.forEach(i => {
            const c = document.createElement('div'); c.className = 'game-card';
            c.innerHTML = `<div><span class="game-icon">${i.i}</span><div class="game-title">${i.t}</div><div class="game-desc">${i.d}</div></div>`;
            c.onclick = () => App.load(i);
            g.appendChild(c);
        });
        window.addEventListener('resize', ()=>Confetti.resize());
    },

    load: (type) => {
        App.type = type; 
        App.diff = 'easy'; $('#difficulty-select').value = 'easy';
        $('#view-menu').classList.remove('active');
        $('#view-game').classList.add('active');
        $('#game-title-display').textContent = type.t;
        App.run();
    },

    run: () => {
        clearInterval(App.timer); 
        App.moves = 0;
        $('#game-board-area').innerHTML = '';
        
        // Init Time based on Mode
        if(App.type.mode === 'score') {
            App.time = 30; // Start Countdown
        } else {
            App.time = 0; // Start Countup
        }
        
        App.updateTimerDisplay();

        App.curr = new App.type.c(App.diff);
        App.curr.init($('#game-board-area'));
        
        App.timer = setInterval(() => {
            if(App.type.mode === 'score') {
                App.time--;
                if(App.time <= 0) App.endGame(true); // End on 0
            } else {
                App.time++;
            }
            App.updateTimerDisplay();
        }, 1000);
    },

    addTime: (sec, isBonus) => {
        const bar = $('.stats-bar');
        
        if (App.type.mode === 'score') {
            App.time += sec; 
        } else {
             App.time = Math.max(0, App.time - sec);
        }
        
        App.updateTimerDisplay();
        
        // Visual Feedback
        bar.classList.remove('time-bonus', 'time-penalty');
        void bar.offsetWidth; // Trigger reflow
        bar.classList.add(isBonus ? 'time-bonus' : 'time-penalty');
    },

    visualPenalty: () => {
        const bar = $('.stats-bar');
        bar.classList.remove('time-bonus', 'time-penalty');
        void bar.offsetWidth;
        bar.classList.add('time-penalty');
    },

    updateTimerDisplay: () => {
        if (App.type.mode === 'score') {
            $('#stat-1').textContent = `${App.time}s`;
        } else {
            const m = Math.floor(App.time / 60).toString().padStart(2, '0');
            const s = (App.time % 60).toString().padStart(2, '0');
            $('#stat-1').textContent = `${m}:${s}`;
        }
    },

    changeDifficulty: (v) => { App.diff = v; App.run(); },

    restartGame: () => { Sound.click(); App.run(); },

    confirmExit: () => { if(confirm("¬øVolver al men√∫?")) App.toMenu(); },

    toMenu: () => {
        clearInterval(App.timer);
        $('#view-game').classList.remove('active');
        $('#view-menu').classList.add('active');
        $('#modal-win').classList.remove('active');
        document.onkeydown = null; document.onmouseup = null;
    },

    endGame: (win) => {
        if(!win) return;
        clearInterval(App.timer); Sound.win(); Confetti.start();
        document.onkeydown = null; document.onmouseup = null;
        
        let scoreToSave = App.time; // Default for Time mode
        let msg = `Tiempo: ${$('#stat-1').textContent}`;

        if(App.type.mode === 'score') {
            scoreToSave = App.curr.score;
            msg = `Puntaje Final: ${scoreToSave}`;
        }

        const rec = Storage.check(App.type.id, App.diff, scoreToSave, App.type.mode);
        $('#win-message').textContent = msg;
        
        $('#record-section').style.display = rec ? 'block' : 'none';
        if(rec) { $('#player-name').value=''; setTimeout(()=>$('#player-name').focus(), 100); }
        $('#modal-win').classList.add('active');
        
        // Save temporary result for modal action
        App.lastScore = scoreToSave;
    },

    handleWinAction: (act) => {
        const inp = $('#player-name');
        if($('#record-section').style.display !== 'none' && inp.value.trim()) {
            Storage.set(App.type.id, App.diff, inp.value.trim(), App.lastScore);
        }
        $('#modal-win').classList.remove('active');
        if(act === 'replay') App.run(); else App.toMenu();
    },

    showRankingGlobal: () => {
        const d = Storage.get(); const l = $('#ranking-list'); l.innerHTML = '';
        if(Object.keys(d).length === 0) l.innerHTML = '<p style="color:#aaa;text-align:center">Sin r√©cords.</p>';
        else {
            App.list.forEach(g => {
                let html = '';
                ['easy','medium','hard','extreme'].forEach(lvl => {
                    const k = `${g.id}_${lvl}`;
                    if(d[k]) {
                        let val = '';
                        if(g.mode === 'score') {
                            val = `${d[k].score} pts`;
                        } else {
                            const m = Math.floor(d[k].score/60).toString().padStart(2,'0');
                            const s = (d[k].score%60).toString().padStart(2,'0');
                            val = `${m}:${s}`;
                        }
                        html += `<li><span>${lvl.toUpperCase()}</span> <b>${d[k].name} (${val})</b></li>`;
                    }
                });
                if(html) l.innerHTML += `<h3 style="color:var(--primary);margin-top:15px;font-size:1rem">${g.i} ${g.t}</h3><ul>${html}</ul>`;
            });
        }
        $('#modal-ranking').classList.add('active');
    }
};

window.onload = App.init;

</script>
</body>
</html>
