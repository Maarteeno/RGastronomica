<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brain Buddy - Ultimate 12</title>
    <style>
        :root {
            /* Palette Dark Elegant */
            --bg-body: #0f172a; 
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 60%, #312e81 100%);
            
            --glass-bg: rgba(30, 41, 59, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            
            --primary: #6366f1;    /* Indigo */
            --secondary: #a855f7;  /* Purple */
            --accent: #38bdf8;     /* Sky */
            --highlight: #fbbf24;  /* Amber */
            
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            --success: #10b981;
            --danger: #f43f5e;
            
            --radius: 16px;
            --font-main: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --shadow: 0 10px 40px -10px rgba(0,0,0,0.6);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; }
        
        body {
            font-family: var(--font-main);
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            overscroll-behavior: none;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* --- Header --- */
        .header {
            text-align: center;
            margin-bottom: 25px;
            animation: fadeInDown 0.8s ease;
        }
        .header h1 { 
            font-size: 2.8rem; 
            background: linear-gradient(to right, #818cf8, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px; 
            font-weight: 800;
        }
        .header p { color: var(--text-muted); font-size: 1rem; letter-spacing: 1px; }

        /* --- Card Container --- */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            border: 1px solid var(--glass-border);
            position: relative;
        }

        /* --- Buttons --- */
        .btn {
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: white;
            user-select: none;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .btn-outline { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-muted); }
        .btn-outline:hover { background: rgba(255,255,255,0.1); color: white; border-color: var(--text-main); }
        .btn-restart { background: rgba(56, 189, 248, 0.15); color: var(--accent); border: 1px solid rgba(56, 189, 248, 0.3); }
        .btn-restart:hover { background: rgba(56, 189, 248, 0.25); }

        /* --- Grid Menu --- */
        .game-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            width: 100%;
        }
        .game-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
            display: flex; flex-direction: column; justify-content: space-between;
            width: 150px; /* Un poco m√°s peque√±o para que quepan bien */
            height: 170px; 
        }
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.08);
            border-color: var(--primary);
        }
        .game-icon { font-size: 2.5rem; margin-bottom: 10px; display: block; filter: drop-shadow(0 0 8px rgba(255,255,255,0.1)); }
        .game-title { font-size: 1rem; margin-bottom: 5px; color: var(--text-main); font-weight: 700; }
        .game-desc { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 15px; line-height: 1.2; }

        /* --- Views --- */
        .view { display: none; animation: fadeIn 0.4s ease; width: 100%; }
        .view.active { display: block; }

        /* --- Game Controls --- */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .controls-left, .controls-right { display: flex; gap: 10px; align-items: center; }

        .stats-bar {
            background: rgba(15, 23, 42, 0.6);
            padding: 8px 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.1rem;
            border: 1px solid var(--glass-border);
            color: var(--accent);
            min-width: 90px; text-align: center;
        }
        
        .time-bonus { animation: flashGreen 0.5s ease; color: var(--success) !important; }
        .time-penalty { animation: flashRed 0.5s ease; color: var(--danger) !important; }

        .difficulty-selector select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: #1e293b;
            color: white;
            cursor: pointer;
            outline: none;
            font-size: 0.9rem;
        }

        #game-board-area {
            min-height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 10px;
            user-select: none;
        }

        /* --- SHARED & SPECIFIC GAME STYLES --- */
        
        /* Grids */
        .memory-grid, .sudoku-grid, .schulte-grid, .matrix-grid, .chimp-grid {
            display: grid; gap: 4px; margin: 0 auto; user-select: none;
        }
        
        /* Memory */
        .memory-card {
            width: 60px; height: 60px; position: relative;
            transform-style: preserve-3d; transition: transform 0.4s; cursor: pointer;
        }
        .memory-card.flip { transform: rotateY(180deg); }
        .front, .back {
            width: 100%; height: 100%; position: absolute;
            backface-visibility: hidden; border-radius: 10px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 1px solid var(--glass-border);
        }
        .front { background: #1e293b; transform: rotateY(180deg); font-size: 1.8rem; }
        .back { background: linear-gradient(135deg, #334155, #475569); }

        /* Cells General */
        .sudoku-cell, .schulte-cell, .matrix-cell, .chimp-cell {
            background: rgba(255,255,255,0.05); border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; cursor: pointer; border: 1px solid var(--glass-border);
            transition: all 0.1s;
        }

        /* Sudoku */
        .sudoku-grid { grid-template-columns: repeat(9, 1fr); gap: 1px; background: #475569; border: 2px solid #475569; max-width: 400px; width: 100%; }
        .sudoku-cell { background: #1e293b; aspect-ratio: 1; font-size: 1.1rem; }
        .sudoku-cell.initial { color: var(--highlight); }
        .sudoku-cell.selected { background: rgba(99, 102, 241, 0.4); }
        .sudoku-cell.error { color: var(--danger); background: rgba(244, 63, 94, 0.2); }
        .numpad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 20px; max-width: 400px; width: 100%; }
        .numpad button { background: rgba(255,255,255,0.1); color: white; border: none; font-size: 1.1rem; padding: 10px; border-radius: 8px; cursor: pointer; }

        /* Schulte */
        .schulte-cell { font-size: 1.5rem; aspect-ratio: 1; }
        .schulte-cell:active { background: var(--primary); transform: scale(0.95); }

        /* Matrix */
        .matrix-cell { aspect-ratio: 1; }
        .matrix-cell.active { background: var(--accent); box-shadow: 0 0 15px var(--accent); }
        .matrix-cell.ok { background: var(--success); }
        .matrix-cell.fail { background: var(--danger); }

        /* Chimp */
        .chimp-cell { font-size: 1.8rem; color: white; aspect-ratio: 1; }
        .chimp-cell.covered { color: transparent; background: white; border-color: white; }
        .chimp-cell.covered:active { background: #e2e8f0; }
        .chimp-cell.hidden { opacity: 0; pointer-events: none; }

        /* Sorter */
        .sorter-container { display: flex; flex-direction: column; align-items: center; gap: 30px; width: 100%; }
        .sorter-card { 
            width: 120px; height: 120px; background: #1e293b; border: 2px solid var(--accent);
            border-radius: 16px; display: flex; justify-content: center; align-items: center;
            font-size: 3rem; font-weight: bold; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .sorter-controls { display: flex; gap: 40px; }
        .sorter-btn { 
            width: 100px; height: 100px; border-radius: 50%; border: none; font-weight: bold; font-size: 1rem; color: white;
            cursor: pointer; transition: transform 0.1s; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .sorter-btn:active { transform: scale(0.9); }
        .btn-left { background: var(--secondary); box-shadow: 0 8px 0 #7e22ce; }
        .btn-right { background: var(--success); box-shadow: 0 8px 0 #047857; }
        .key-hint { font-size: 0.7rem; opacity: 0.7; margin-top: 5px; }

        /* Stopwatch */
        .stopwatch-display { 
            font-size: 5rem; font-family: 'Courier New', monospace; font-weight: bold; 
            color: var(--accent); text-shadow: 0 0 20px rgba(56, 189, 248, 0.3); margin: 30px 0;
        }
        .stopwatch-target { font-size: 1.5rem; color: var(--text-muted); margin-bottom: 20px; }
        .stopwatch-btn { 
            width: 140px; height: 140px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.1);
            background: var(--danger); color: white; font-size: 1.5rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 30px rgba(244, 63, 94, 0.4); transition: all 0.2s;
        }
        .stopwatch-btn:active { transform: scale(0.95); background: #be123c; }
        .stopwatch-btn.running { background: #eab308; box-shadow: 0 0 30px rgba(234, 179, 8, 0.4); }

        /* Word Search & Diff & Stroop */
        .ws-grid { display: grid; gap: 2px; background: #334155; padding: 3px; border-radius: 8px; touch-action: none; }
        .ws-cell { background: #1e293b; width: 28px; height: 28px; display: flex; justify-content: center; align-items: center; font-weight: 600; cursor: pointer; font-size: 0.8rem; color: #cbd5e1; }
        .ws-cell.selected { background: var(--highlight); color: #0f172a; } .ws-cell.found { background: var(--success); color: #0f172a; }
        .stroop-word { font-size: 3.5rem; font-weight: 900; margin: 20px 0; text-shadow: 0 0 20px rgba(0,0,0,0.5); letter-spacing: 2px; }
        .choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .choice-btn { font-size: 1.3rem; padding: 15px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 12px; }
        .anagram-pool, .anagram-slots { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
        .letter-btn { width: 45px; height: 45px; border-radius: 8px; font-size: 1.5rem; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .diff-cell { background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 1.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; aspect-ratio: 1; }

        /* --- Modals --- */
        #confetti-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 1000; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #1e293b; padding: 30px; border-radius: 20px;
            max-width: 380px; width: 90%; text-align: center;
            border: 1px solid var(--glass-border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal h2 { color: var(--primary); margin-bottom: 10px; font-size: 1.8rem; }
        .modal input {
            width: 100%; padding: 12px; margin: 10px 0 20px 0;
            border: 1px solid #334155; border-radius: 10px;
            font-size: 1.1rem; background: #0f172a; color: white; text-align: center;
        }
        #ranking-list { max-height: 350px; overflow-y: auto; text-align: left; }
        #ranking-list li { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; display: flex; justify-content: space-between; }
        #ranking-list b { color: var(--accent); }

        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes flashGreen { 0% { background: rgba(16, 185, 129, 0); } 50% { background: rgba(16, 185, 129, 0.3); } 100% { background: transparent; } }
        @keyframes flashRed { 0% { background: rgba(244, 63, 94, 0); } 50% { background: rgba(244, 63, 94, 0.3); } 100% { background: transparent; } }

        @media (max-width: 600px) {
            .header h1 { font-size: 2rem; }
            .game-grid { gap: 10px; }
            .game-card { width: 45%; height: 150px; }
            .stopwatch-display { font-size: 3.5rem; }
            .stopwatch-btn { width: 110px; height: 110px; }
        }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div class="container">
        <header class="header">
            <h1>üß† Brain Buddy</h1>
            <p>12 Juegos Mentales</p>
        </header>

        <div id="view-menu" class="view active">
            <div class="game-grid"></div>
            <div style="margin-top: 40px; text-align: center; width: 100%;">
                 <button class="btn btn-outline" onclick="App.showRankingGlobal()">üèÜ Ver R√©cords</button>
            </div>
        </div>

        <div id="view-game" class="view">
            <div class="card">
                <div class="game-header">
                    <div class="controls-left">
                        <button class="btn btn-outline" onclick="App.confirmExit()">‚¨Ö Men√∫</button>
                        <div class="difficulty-selector">
                            <select id="difficulty-select" onchange="App.changeDifficulty(this.value)">
                                <option value="easy">F√°cil</option>
                                <option value="medium">Medio</option>
                                <option value="hard">Dif√≠cil</option>
                                <option value="extreme">Extremo</option>
                            </select>
                        </div>
                    </div>
                    <div class="controls-right">
                        <div class="stats-bar"><span id="stat-1">00:00</span></div>
                        <span id="stat-2" style="font-weight:bold; color:var(--highlight)"></span>
                        <button class="btn btn-restart" onclick="App.restartGame()" title="Reiniciar Juego">‚Üª Reiniciar</button>
                    </div>
                </div>
                
                <div id="game-title-display" style="text-align: center; margin-bottom: 20px; color: var(--primary); font-size: 1.5rem; font-weight: 700; letter-spacing: 1px;"></div>
                
                <div id="game-board-area"></div>
            </div>
        </div>
    </div>

    <div id="modal-win" class="modal-overlay">
        <div class="modal">
            <h2>üéâ Fin del Juego</h2>
            <p id="win-message">Resultados.</p>
            <div id="record-section" style="display:none; margin-top:15px;">
                <p style="color: var(--success); font-weight: bold; margin-bottom: 5px;">¬°NUEVO R√âCORD!</p>
                <input type="text" id="player-name" placeholder="Tu nombre..." maxlength="12" autocomplete="off">
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="App.handleWinAction('replay')">‚Üª Jugar de nuevo</button>
                <button class="btn btn-outline" onclick="App.handleWinAction('exit')">‚ûú Salir</button>
            </div>
        </div>
    </div>

    <div id="modal-ranking" class="modal-overlay">
        <div class="modal">
            <h2>üèÜ R√©cords</h2>
            <div id="ranking-list"></div>
            <button class="btn btn-primary" style="margin-top:15px; width:100%" onclick="document.getElementById('modal-ranking').classList.remove('active')">Cerrar</button>
        </div>
    </div>

<script>
/** BRAIN BUDDY CORE v11 */
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

const Sound = {
    ctx: new (window.AudioContext || window.webkitAudioContext)(),
    play: function(freq, type, dur, vol=0.1) {
        if(this.ctx.state === 'suspended') this.ctx.resume();
        const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
        o.type = type; o.frequency.value = freq;
        g.gain.setValueAtTime(vol, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime + dur);
    },
    win: () => { Sound.play(400,'sine',0.1); setTimeout(()=>Sound.play(600,'sine',0.1),100); setTimeout(()=>Sound.play(800,'triangle',0.4,0.2),200); },
    click: () => Sound.play(300,'sine',0.05,0.05),
    error: () => Sound.play(150,'sawtooth',0.3,0.08),
    merge: () => Sound.play(500,'square',0.05,0.05)
};

const Storage = {
    get: () => JSON.parse(localStorage.getItem('brainBuddy_v11')) || {},
    save: (d) => localStorage.setItem('brainBuddy_v11', JSON.stringify(d)),
    check: (id, diff, score, mode) => {
        const d = Storage.get();
        const cur = d[`${id}_${diff}`];
        if(!cur) return true;
        if (mode === 'score') return score > cur.score;
        return score < cur.score; // time
    },
    set: (id, diff, name, score) => {
        const d = Storage.get();
        d[`${id}_${diff}`] = { name, score, date: new Date().toLocaleDateString() };
        Storage.save(d);
    }
};

const Confetti = {
    canvas: document.getElementById('confetti-canvas'),
    ctx: document.getElementById('confetti-canvas').getContext('2d'),
    particles: [], active: false,
    resize: function() { this.canvas.width=window.innerWidth; this.canvas.height=window.innerHeight; },
    start: function() {
        this.resize(); this.particles=[];
        const colors = ['#6366f1', '#a855f7', '#38bdf8', '#10b981', '#fbbf24'];
        for(let i=0; i<100; i++) this.particles.push({ x: Math.random()*this.canvas.width, y: Math.random()*this.canvas.height-this.canvas.height, c: colors[Math.floor(Math.random()*colors.length)], vx: Math.random()*2-1, vy: Math.random()*3+2, s: Math.random()*8+4 });
        this.active=true; this.loop(); setTimeout(()=>this.stop(), 3000);
    },
    stop: function() { this.active=false; this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height); },
    loop: function() {
        if(!this.active) return;
        this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
        this.particles.forEach(p=>{ p.y+=p.vy; p.x+=p.vx; this.ctx.fillStyle=p.c; this.ctx.fillRect(p.x,p.y,p.s,p.s); if(p.y>this.canvas.height) p.y=-10; });
        requestAnimationFrame(()=>this.loop());
    }
};

/* --- NEW GAMES --- */

// 10. Chimp Test
class ChimpGame {
    constructor(diff) {
        this.diff = diff;
        this.level = 4; // Start numbers
        this.maxLevel = diff==='easy'?8:(diff==='medium'?12:(diff==='hard'?18:36));
        this.lives = 3;
        this.nums = [];
        this.current = 1;
        this.isCovered = false;
    }
    init(c) { this.cont = c; this.load(); }
    load() {
        this.nums = [];
        this.current = 1;
        this.isCovered = false;
        $('#stat-2').textContent = `Nivel: ${this.level} | ‚ù§Ô∏è ${this.lives}`;
        
        // Grid size depends on level
        const sz = this.level <= 9 ? 5 : 6;
        const positions = [];
        while(positions.length < this.level) {
            const p = Math.floor(Math.random() * (sz*sz));
            if(!positions.includes(p)) positions.push(p);
        }
        
        this.cont.innerHTML = `
            <div class="chimp-grid" style="grid-template-columns:repeat(${sz},1fr); width:${sz*60}px;">
                ${Array(sz*sz).fill(0).map((_,i) => {
                    const idx = positions.indexOf(i);
                    return idx !== -1 
                        ? `<div class="chimp-cell" id="ch-${i}" onclick="App.curr.click(${i}, ${idx+1})">${idx+1}</div>` 
                        : `<div class="chimp-cell hidden"></div>`
                }).join('')}
            </div>
            <div style="margin-top:20px; text-align:center; color:var(--text-muted)">Memoriza y pulsa en orden</div>
        `;
    }
    click(id, num) {
        if(num !== this.current) {
            this.lives--;
            Sound.error();
            if(this.lives <= 0) App.endGame(true);
            else { 
                $('#stat-2').textContent = `Nivel: ${this.level} | ‚ù§Ô∏è ${this.lives}`;
                alert("¬°Fallo! Reintentando nivel...");
                this.load(); 
            }
            return;
        }

        Sound.click();
        
        // Logic: If click '1', hide others
        if(this.current === 1) {
            this.isCovered = true;
            $$('.chimp-cell').forEach(el => {
                if(!el.classList.contains('hidden') && el.textContent !== '1') {
                    el.classList.add('covered');
                }
            });
        }
        
        // Hide clicked
        $(`#ch-${id}`).classList.add('hidden');
        this.current++;
        
        if(this.current > this.level) {
            Sound.merge();
            this.level++;
            setTimeout(()=>this.load(), 500);
        }
    }
    get score() { return this.level; }
}

// 11. Speed Sorter
class SorterGame {
    constructor(diff) {
        this.diff = diff;
        this.score = 0;
        this.mode = (diff==='easy'||diff==='medium') ? 'nums' : 'chars';
        this.currentVal = null;
        this.currentType = null; // 0: Left, 1: Right
    }
    init(c) {
        this.cont = c;
        // Keyboard support
        document.onkeydown = (e) => {
            if(e.key === 'ArrowLeft') this.check(0);
            if(e.key === 'ArrowRight') this.check(1);
        };
        this.next();
    }
    next() {
        $('#stat-2').textContent = `Pts: ${this.score}`;
        let txt = '', type = 0; // 0 left, 1 right
        
        if(this.mode === 'nums') {
            const n = Math.floor(Math.random() * 100);
            txt = n;
            type = (n % 2 === 0) ? 0 : 1; // 0: Par, 1: Impar
        } else {
            const vowels = "AEIOU";
            const cons = "BCDFGHJKLMNPQRSTVWXYZ";
            if(Math.random() > 0.5) {
                txt = vowels[Math.floor(Math.random()*vowels.length)];
                type = 0; // Vocal
            } else {
                txt = cons[Math.floor(Math.random()*cons.length)];
                type = 1; // Consonante
            }
        }
        
        const labelL = this.mode === 'nums' ? 'PAR' : 'VOCAL';
        const labelR = this.mode === 'nums' ? 'IMPAR' : 'CONST';
        
        this.currentType = type;
        this.cont.innerHTML = `
            <div class="sorter-container">
                <div class="sorter-card">${txt}</div>
                <div class="sorter-controls">
                    <button class="sorter-btn btn-left" onclick="App.curr.check(0)">
                        ${labelL} <span class="key-hint">‚¨Ö</span>
                    </button>
                    <button class="sorter-btn btn-right" onclick="App.curr.check(1)">
                        ${labelR} <span class="key-hint">‚û°</span>
                    </button>
                </div>
            </div>
        `;
    }
    check(side) {
        if(side === this.currentType) {
            this.score += 5;
            Sound.click();
        } else {
            this.score = Math.max(0, this.score - 5);
            Sound.error();
            App.visualPenalty();
        }
        this.next();
    }
}

// 12. Mental Stopwatch
class StopwatchGame {
    constructor(diff) {
        this.diff = diff;
        // Targets: Easy 10, Med 5, Hard 10, Ext 15
        this.targetTime = (diff==='medium'||diff==='extreme'&&false) ? 5 : 10; 
        if(diff==='extreme') this.targetTime = 15;
        
        // Visibility limit: Hard=4, Ext=5, others=Infinite
        this.visLimit = (diff==='hard') ? 4 : ((diff==='extreme') ? 5 : 999);
        
        this.startTime = 0;
        this.running = false;
        this.score = 0;
        this.attempts = 3;
        this.interval = null;
    }
    init(c) {
        this.cont = c;
        this.renderState();
    }
    renderState() {
        $('#stat-2').textContent = `Pts: ${this.score.toFixed(0)} | Turnos: ${this.attempts}`;
        this.cont.innerHTML = `
            <div style="text-align:center">
                <div class="stopwatch-target">META: ${this.targetTime}.00 seg</div>
                <div class="stopwatch-display">0.00</div>
                <button class="stopwatch-btn ${this.running?'running':''}" onclick="App.curr.toggle()">
                    ${this.running ? 'STOP' : 'START'}
                </button>
                <div style="margin-top:20px; color:var(--text-muted); font-size:0.9rem">
                    ${this.diff==='hard'||this.diff==='extreme' ? `(Se oculta a los ${this.visLimit}s)` : '(Visible siempre)'}
                </div>
            </div>
        `;
    }
    toggle() {
        if(!this.running) {
            if(this.attempts <= 0) return;
            this.running = true;
            this.startTime = Date.now();
            Sound.click();
            this.renderState();
            this.loop();
        } else {
            this.stop();
        }
    }
    loop() {
        if(!this.running) return;
        const diff = (Date.now() - this.startTime) / 1000;
        const disp = $('.stopwatch-display');
        
        if(diff > this.visLimit) {
            disp.textContent = "?.??";
            disp.style.color = "#555";
        } else {
            disp.textContent = diff.toFixed(2);
            disp.style.color = "var(--accent)";
        }
        
        requestAnimationFrame(()=>this.loop());
    }
    stop() {
        this.running = false;
        const actual = (Date.now() - this.startTime) / 1000;
        const delta = Math.abs(actual - this.targetTime);
        $('.stopwatch-display').textContent = actual.toFixed(3);
        
        // Score: Max 100 per round. 
        // 0.00 diff = 100pts. 1.00 diff = 0pts.
        let pts = Math.max(0, 100 - (delta * 100));
        this.score += pts;
        this.attempts--;
        
        Sound.win(); // Ding sound for stop
        
        setTimeout(() => {
            if(this.attempts <= 0) App.endGame(true);
            else this.renderState();
        }, 2000);
    }
}

/* --- EXISTING GAMES (Brief versions) --- */
class MemoryGame {
    constructor(diff){this.diff=diff;this.cards=[];this.flipped=[];this.locked=false;this.matched=0;this.streak=0;
    this.cols=diff==='easy'?4:(diff==='medium'?5:6);this.rows=diff==='easy'?4:(diff==='medium'?4:6);
    const t=['üçé','üçå','üçí','üçá','üçâ','üçã','ü•ù','ü••','ü•ë','üçÜ','ü•ï','üåΩ','ü•¶','üå∂Ô∏è','üçÑ','ü•ú','üçû','üßÄ','üçñ','üçó'];
    let p=[];while(p.length<(this.cols*this.rows)/2)p.push(t[Math.floor(Math.random()*t.length)]);
    this.cards=[...p,...p].sort(()=>0.5-Math.random());}
    init(c){c.innerHTML=`<div class="memory-grid" style="grid-template-columns:repeat(${this.cols},1fr)">${this.cards.map((e,i)=>`<div class="memory-card" id="c-${i}" onclick="App.curr.flip(${i})"><div class="front">${e}</div><div class="back"></div></div>`).join('')}</div>`;}
    flip(i){let c=$(`#c-${i}`);if(this.locked||c.classList.contains('flip'))return;c.classList.add('flip');Sound.click();this.flipped.push({id:i,v:this.cards[i],e:c});
    if(this.flipped.length===2){this.locked=true;App.moves++;if(this.flipped[0].v===this.flipped[1].v){this.matched++;this.streak++;if(this.streak>=2){App.addTime(5,false);this.streak=0;}this.flipped=[];this.locked=false;if(this.matched===this.cards.length/2)App.endGame(true);}else{this.streak=0;Sound.error();setTimeout(()=>{this.flipped.forEach(x=>x.e.classList.remove('flip'));this.flipped=[];this.locked=false;},800);}}}
}
class MathGame {
    constructor(diff){this.diff=diff;this.score=0;this.combo=0;this.bonus=diff==='easy'?2:(diff==='medium'?3:5);}
    init(c){c.innerHTML=`<div style="text-align:center"><div class="stroop-word" style="font-size:2.5rem" id="mp"></div><div class="choice-grid" id="mo"></div></div>`;this.next();}
    next(){let o=['+','-','*'],op=o[Math.floor(Math.random()*(this.diff==='easy'?2:3))],a,b,r;
    if(op==='*'){a=Math.floor(Math.random()*9)+2;b=Math.floor(Math.random()*9)+2;r=a*b;}else{a=Math.floor(Math.random()*20)+1;b=Math.floor(Math.random()*20)+1;r=op==='+'?a+b:a-b;}
    $('#mp').textContent=`${a} ${op} ${b}`;$('#stat-2').textContent=`Pts: ${this.score}`;
    let ch=[r];while(ch.length<4){let x=r+Math.floor(Math.random()*10)-5;if(!ch.includes(x))ch.push(x);}
    $('#mo').innerHTML=ch.sort(()=>0.5-Math.random()).map(x=>`<button class="choice-btn" onclick="App.curr.chk(${x},${r})">${x}</button>`).join('');}
    chk(v,r){if(v===r){this.score+=10;this.combo++;Sound.click();if(this.combo%3===0)App.addTime(this.bonus,true);this.next();}else{this.score=Math.max(0,this.score-5);this.combo=0;Sound.error();App.visualPenalty();this.next();}}
}
class AnagramGame { constructor(d){this.d=d;this.sc=0;this.cm=0;this.w=['GATO','SOL','LUZ','MAR','PAN','VINO','CASA','ARBOL','TREN'];this.t=[];this.pool=[];this.s=[];}
    init(c){this.c=c;this.load();document.onkeydown=(e)=>{if(e.key.match(/[a-z√±]/i)){let f=this.pool.find(x=>x.l===e.key.toUpperCase());if(f)this.cp(f.id);}if(e.key==='Backspace'){let i=this.s.map((x,k)=>x?k:-1).filter(x=>x!==-1).pop();if(i!==undefined)this.cs(i);}};}
    load(){if(!this.t.length)this.t=[...this.w].sort(()=>0.5-Math.random());this.cw=this.t.pop();this.pool=this.cw.split('').sort(()=>0.5-Math.random()).map((l,i)=>({l,id:i}));this.s=Array(this.cw.length).fill(null);this.render();}
    render(){$('#stat-2').textContent=`Pts: ${this.sc}`;this.c.innerHTML=`<div class="anagram-slots">${this.s.map((x,i)=>x?`<div class="letter-btn" onclick="App.curr.cs(${i})">${x.l}</div>`:`<div class="letter-btn empty"></div>`).join('')}</div><div class="anagram-pool">${this.pool.map(x=>`<div class="letter-btn" onclick="App.curr.cp(${x.id})">${x.l}</div>`).join('')}</div>`;}
    cp(id){let pi=this.pool.findIndex(x=>x.id===id),si=this.s.findIndex(x=>x===null);if(pi>-1&&si>-1){this.s[si]=this.pool[pi];this.pool.splice(pi,1);Sound.click();this.render();this.chk();}}
    cs(i){if(this.s[i]){this.pool.push(this.s[i]);this.s[i]=null;Sound.click();this.render();}}
    chk(){if(!this.s.includes(null)){if(this.s.map(x=>x.l).join('')===this.cw){Sound.merge();this.sc+=10;this.cm++;if(this.cm%3===0)App.addTime(3,true);setTimeout(()=>this.load(),300);}else{Sound.error();this.sc=Math.max(0,this.sc-5);this.cm=0;App.visualPenalty();this.pool=this.cw.split('').sort(()=>0.5-Math.random()).map((l,i)=>({l,id:i}));this.s=Array(this.cw.length).fill(null);setTimeout(()=>this.render(),300);}}}
}
class MatrixGame { constructor(d){this.rd=1;this.mx=5;this.cfg=d==='easy'?[3,3]:(d==='medium'?[4,5]:[5,7]);this.sz=this.cfg[0];this.tc=this.cfg[1];this.tg=[];this.sl=[];this.ok=false;}
    init(c){this.c=c;this.ld();}
    ld(){if(this.rd>this.mx){App.endGame(true);return;}$('#stat-2').textContent=`Ronda ${this.rd}/${this.mx}`;this.c.innerHTML=`<div class="matrix-grid" style="grid-template-columns:repeat(${this.sz},1fr);width:${this.sz*60}px">${Array(this.sz*this.sz).fill(0).map((_,i)=>`<div class="matrix-cell" id="mt-${i}" onclick="App.curr.ck(${i})"></div>`).join('')}</div>`;this.tg=[];while(this.tg.length<this.tc){let r=Math.floor(Math.random()*this.sz*this.sz);if(!this.tg.includes(r))this.tg.push(r);}setTimeout(()=>{this.tg.forEach(x=>$(`#mt-${x}`).classList.add('active'));Sound.click();},500);setTimeout(()=>{this.tg.forEach(x=>$(`#mt-${x}`).classList.remove('active'));this.ok=true;this.sl=[];},2000);}
    ck(i){if(!this.ok)return;if(this.sl.includes(i))return;if(this.tg.includes(i)){$(`#mt-${i}`).classList.add('ok');this.sl.push(i);Sound.click();if(this.sl.length===this.tc){this.ok=false;Sound.merge();setTimeout(()=>{this.rd++;this.ld();},800);}}else{$(`#mt-${i}`).classList.add('fail');Sound.error();this.ok=false;this.tg.forEach(x=>$(`#mt-${x}`).classList.add('active'));setTimeout(()=>this.ld(),1500);}}
}
class SchulteGame { constructor(d){this.sz=d==='easy'?3:(d==='medium'?4:5);this.mx=this.sz*this.sz;this.cur=1;this.n=[];}
    init(c){this.n=Array.from({length:this.mx},(_,i)=>i+1).sort(()=>0.5-Math.random());$('#stat-2').textContent=`Busca: 1`;c.innerHTML=`<div class="schulte-grid" style="grid-template-columns:repeat(${this.sz},1fr);width:${this.sz*55}px">${this.n.map(x=>`<div class="schulte-cell" onclick="App.curr.ck(this,${x})">${x}</div>`).join('')}</div>`;}
    ck(e,v){if(v===this.cur){Sound.click();e.style.opacity='0.3';e.style.pointerEvents='none';this.cur++;if(this.cur>this.mx)App.endGame(true);else $('#stat-2').textContent=`Busca: ${this.cur}`;}else Sound.error();}
}
class Sudoku { constructor(d){this.d=d;this.b=[];this.s=[];}
    init(c){c.innerHTML=`<div class="sudoku-grid" id="sb"></div><div class="numpad" id="sp"></div>`;this.gen();let b=$('#sb');this.b.forEach((r,i)=>r.forEach((v,j)=>{let d=document.createElement('div');d.className=`sudoku-cell ${v?'initial':''}`;d.textContent=v||'';d.onclick=()=>{if(!v)this.sel(d,i,j)};b.appendChild(d);}));[1,2,3,4,5,6,7,8,9,'‚å´'].forEach(x=>{let bt=document.createElement('button');bt.textContent=x;bt.onclick=()=>this.inp(x);$('#sp').appendChild(bt);});}
    sel(e,r,c){$$('.selected').forEach(x=>x.classList.remove('selected'));this.cur={e,r,c};e.classList.add('selected');}
    inp(v){if(!this.cur)return;let val=v==='‚å´'?0:v;this.cur.e.textContent=val||'';this.b[this.cur.r][this.cur.c]=val;if(val&&val!=this.s[this.cur.r][this.cur.c]){this.cur.e.classList.add('error');Sound.error();}else{this.cur.e.classList.remove('error');Sound.click();if(this.b.every((r,i)=>r.every((c,j)=>c===this.s[i][j])))App.endGame(true);}}
    gen(){this.s=Array(9).fill().map(()=>Array(9).fill(0));const f=(r,c)=>{let n=[1,2,3,4,5,6,7,8,9].sort(()=>0.5-Math.random());for(let x of n)if(this.v(r,c,x)){this.s[r][c]=x;if(c===8?(r===8?1:f(r+1,0)):f(r,c+1))return 1;this.s[r][c]=0;}return 0;};f(0,0);this.b=JSON.parse(JSON.stringify(this.s));let k=this.d==='easy'?30:45;while(k>0){let r=Math.floor(Math.random()*9),c=Math.floor(Math.random()*9);if(this.b[r][c]){this.b[r][c]=0;k--;}}}
    v(r,c,x){for(let k=0;k<9;k++)if(this.s[r][k]===x||this.s[k][c]===x)return 0;let br=Math.floor(r/3)*3,bc=Math.floor(c/3)*3;for(let i=0;i<3;i++)for(let j=0;j<3;j++)if(this.s[br+i][bc+j]===x)return 0;return 1;}
}
class WordSearch { constructor(d){this.sz=10;this.w=['JAVA','CODE','BYTE','WEB','APP'];this.bd=[];this.fd=0;}
    init(c){c.innerHTML=`<div style="text-align:center;margin-bottom:10px">Encuentra: ${this.w.join(', ')}</div><div class="ws-grid" style="grid-template-columns:repeat(${this.sz},1fr);width:${this.sz*28}px" id="wb"></div>`;this.gen();let b=$('#wb');this.bd.forEach((r,i)=>r.forEach((l,j)=>{let d=document.createElement('div');d.className='ws-cell';d.textContent=l;d.dataset.r=i;d.dataset.c=j;b.appendChild(d);}));this.evt(b);}
    gen(){this.bd=Array(this.sz).fill().map(()=>Array(this.sz).fill(''));this.w.forEach(w=>{let p=0;while(!p){let d=Math.floor(Math.random()*2),r=Math.floor(Math.random()*this.sz),c=Math.floor(Math.random()*this.sz);if(this.ck(w,r,c,d)){for(let i=0;i<w.length;i++)this.bd[r+(d?i:0)][c+(d?0:i)]=w[i];p=1;}}});const a="ABCDEFGHIJKLMNOPQRSTUVWXYZ";for(let i=0;i<this.sz;i++)for(let j=0;j<this.sz;j++)if(!this.bd[i][j])this.bd[i][j]=a[Math.floor(Math.random()*a.length)];}
    ck(w,r,c,d){if((d&&r+w.length>this.sz)||(!d&&c+w.length>this.sz))return 0;for(let i=0;i<w.length;i++)if(this.bd[r+(d?i:0)][c+(d?0:i)])return 0;return 1;}
    evt(b){let s=0,st,pth=[];const g=e=>e.target.closest('.ws-cell');
    b.onmousedown=e=>{let c=g(e);if(c){s=1;st={r:+c.dataset.r,c:+c.dataset.c};}};
    b.onmousemove=e=>{if(s){let c=g(e);if(c){$$('.selected').forEach(x=>x.classList.remove('selected'));let en={r:+c.dataset.r,c:+c.dataset.c},dr=en.r-st.r,dc=en.c-st.c;pth=[];if(!dr||!dc||Math.abs(dr)===Math.abs(dc)){let mx=Math.max(Math.abs(dr),Math.abs(dc)),ir=dr?dr/Math.abs(dr):0,ic=dc?dc/Math.abs(dc):0;for(let i=0;i<=mx;i++)pth.push({r:st.r+i*ir,c:st.c+i*ic});pth.forEach(p=>$(`.ws-cell[data-r="${p.r}"][data-c="${p.c}"]`)?.classList.add('selected'));}}}};
    document.onmouseup=()=>{if(s){s=0;let t=pth.map(p=>this.bd[p.r][p.c]).join('');if(this.w.includes(t)){this.fd++;pth.forEach(p=>$(`.ws-cell[data-r="${p.r}"][data-c="${p.c}"]`).classList.add('found'));Sound.click();if(this.fd===this.w.length)App.endGame(true);}$$('.selected').forEach(x=>x.classList.remove('selected'));}};}
}
class DiffGame { constructor(d){this.l=1;this.m=d==='easy'?3:5;}init(c){this.c=c;this.ld();}ld(){let s=Math.min(this.l+2,6),e=['üòÄ','üòé','üëΩ','ü§ñ'],b=e[Math.floor(Math.random()*4)],d;do{d=e[Math.floor(Math.random()*4)]}while(d===b);let t=Math.floor(Math.random()*s*s);this.c.innerHTML=`<div style="text-align:center;margin-bottom:10px">Nivel ${this.l}/${this.m}</div><div class="diff-grid" style="display:grid;grid-template-columns:repeat(${s},1fr);gap:5px;max-width:300px;margin:0 auto">${Array(s*s).fill(0).map((_,i)=>`<div class="diff-cell" onclick="${i===t?`App.curr.ok()`:`Sound.error()`}">${i===t?d:b}</div>`).join('')}</div>`;}ok(){Sound.click();this.l++;if(this.l>this.m)App.endGame(true);else this.ld();}}
class StroopGame { constructor(d){this.s=0;this.m=10;this.cl=[{n:'ROJO',c:'#f00'},{n:'AZUL',c:'#00f'},{n:'VERDE',c:'#0f0'}];}init(c){c.innerHTML=`<div style="text-align:center"><div id="sq" style="font-size:1.2rem"></div><div id="sw" style="font-size:3rem;font-weight:bold;margin:20px"></div><div class="choice-grid" id="so"></div></div>`;this.nx();}nx(){let t=this.cl[Math.floor(Math.random()*3)],c;do{c=this.cl[Math.floor(Math.random()*3)]}while(c.n===t.n);let m=Math.random()>.5;$('#sq').innerHTML=m?'¬øQu√© <b>COLOR</b>?':'¬øQu√© <b>DICE</b>?';$('#sw').textContent=t.n;$('#sw').style.color=c.c;let a=m?c.n:t.n,o=[a];while(o.length<3){let x=this.cl[Math.floor(Math.random()*3)].n;if(!o.includes(x))o.push(x);}$('#so').innerHTML=o.sort(()=>.5-Math.random()).map(x=>`<button class="choice-btn" onclick="App.curr.ck('${x}','${a}')">${x}</button>`).join('');}ck(v,r){if(v===r){this.s++;Sound.click();if(this.s>=this.m)App.endGame(true);else this.nx();}else{Sound.error();this.nx();}}}

/* --- APP CONTROLLER --- */
const App = {
    curr: null, type: null, diff: 'easy', time: 0, timer: null, moves: 0,
    list: [
        { id:'mem', t:'Memoria', i:'üß©', d:'Parejas', c:MemoryGame, mode:'time' },
        { id:'mat', t:'C√°lculo', i:'‚úñÔ∏è', d:'Arcade', c:MathGame, mode:'score' },
        { id:'ana', t:'Anagrama', i:'üî°', d:'Arcade', c:AnagramGame, mode:'score' },
        { id:'chp', t:'Chimpanc√©', i:'üêµ', d:'Memoria', c:ChimpGame, mode:'score' }, // NEW
        { id:'srt', t:'Clasifica', i:'‚öñÔ∏è', d:'Veloz', c:SorterGame, mode:'score' }, // NEW
        { id:'stw', t:'Cron√≥metro', i:'‚è±Ô∏è', d:'Mental', c:StopwatchGame, mode:'score' }, // NEW
        { id:'mtx', t:'Matriz', i:'üü¶', d:'Patrones', c:MatrixGame, mode:'time' },
        { id:'sch', t:'Schulte', i:'üî¢', d:'Atenci√≥n', c:SchulteGame, mode:'time' },
        { id:'sud', t:'Sudoku', i:'‚úèÔ∏è', d:'L√≥gica', c:Sudoku, mode:'time' },
        { id:'wrd', t:'Sopa Letras', i:'üîé', d:'Buscar', c:WordSearch, mode:'time' },
        { id:'dif', t:'Intruso', i:'üßê', d:'Visual', c:DiffGame, mode:'time' },
        { id:'str', t:'Confusi√≥n', i:'üé®', d:'Stroop', c:StroopGame, mode:'time' }
    ],

    init: () => {
        const g = $('.game-grid');
        App.list.forEach(i => {
            const c = document.createElement('div'); c.className = 'game-card';
            c.innerHTML = `<div><span class="game-icon">${i.i}</span><div class="game-title">${i.t}</div><div class="game-desc">${i.d}</div></div>`;
            c.onclick = () => App.load(i);
            g.appendChild(c);
        });
        window.addEventListener('resize', ()=>Confetti.resize());
    },

    load: (type) => {
        App.type = type; 
        App.diff = 'easy'; $('#difficulty-select').value = 'easy';
        $('#view-menu').classList.remove('active');
        $('#view-game').classList.add('active');
        $('#game-title-display').textContent = type.t;
        App.run();
    },

    run: () => {
        clearInterval(App.timer); 
        App.moves = 0;
        $('#game-board-area').innerHTML = '';
        
        // Init Time based on Mode
        if(App.type.mode === 'score' && App.type.id !== 'chp' && App.type.id !== 'stw') {
            App.time = 30; // Start Countdown for Arcade games
        } else {
            App.time = 0; // Countup or Custom logic
        }
        
        App.updateTimerDisplay();
        App.curr = new App.type.c(App.diff);
        App.curr.init($('#game-board-area'));
        
        // Timer Logic
        if(App.type.id === 'stw') return; // Stopwatch handles its own timing

        App.timer = setInterval(() => {
            if(App.type.mode === 'score' && App.type.id !== 'chp') {
                App.time--;
                if(App.time <= 0) App.endGame(true);
            } else {
                App.time++;
            }
            App.updateTimerDisplay();
        }, 1000);
    },

    addTime: (sec, isBonus) => {
        const bar = $('.stats-bar');
        if (App.type.mode === 'score') App.time += sec; 
        else App.time = Math.max(0, App.time - sec);
        App.updateTimerDisplay();
        bar.classList.remove('time-bonus', 'time-penalty');
        void bar.offsetWidth; 
        bar.classList.add(isBonus ? 'time-bonus' : 'time-penalty');
    },

    visualPenalty: () => {
        const bar = $('.stats-bar');
        bar.classList.remove('time-bonus', 'time-penalty');
        void bar.offsetWidth;
        bar.classList.add('time-penalty');
    },

    updateTimerDisplay: () => {
        if(App.type.id === 'stw') return;
        if (App.type.mode === 'score' && App.type.id !== 'chp') {
            $('#stat-1').textContent = `${App.time}s`;
        } else {
            const m = Math.floor(App.time / 60).toString().padStart(2, '0');
            const s = (App.time % 60).toString().padStart(2, '0');
            $('#stat-1').textContent = `${m}:${s}`;
        }
    },

    changeDifficulty: (v) => { App.diff = v; App.run(); },
    restartGame: () => { Sound.click(); App.run(); },
    confirmExit: () => { if(confirm("¬øVolver al men√∫?")) App.toMenu(); },

    toMenu: () => {
        clearInterval(App.timer);
        $('#view-game').classList.remove('active');
        $('#view-menu').classList.add('active');
        $('#modal-win').classList.remove('active');
        if(App.curr && App.curr.stop) App.curr.stop(); // Stop loop if exists
        document.onkeydown = null; 
    },

    endGame: (win) => {
        if(!win) return;
        clearInterval(App.timer); Sound.win(); Confetti.start();
        document.onkeydown = null; 
        
        let scoreToSave = App.time; 
        let msg = `Tiempo: ${$('#stat-1').textContent}`;

        if(App.type.mode === 'score') {
            scoreToSave = App.curr.score || App.curr.level || 0;
            msg = `Puntaje Final: ${scoreToSave}`;
        }

        const rec = Storage.check(App.type.id, App.diff, scoreToSave, App.type.mode);
        $('#win-message').textContent = msg;
        
        $('#record-section').style.display = rec ? 'block' : 'none';
        if(rec) { $('#player-name').value=''; setTimeout(()=>$('#player-name').focus(), 100); }
        $('#modal-win').classList.add('active');
        App.lastScore = scoreToSave;
    },

    handleWinAction: (act) => {
        const inp = $('#player-name');
        if($('#record-section').style.display !== 'none' && inp.value.trim()) {
            Storage.set(App.type.id, App.diff, inp.value.trim(), App.lastScore);
        }
        $('#modal-win').classList.remove('active');
        if(act === 'replay') App.run(); else App.toMenu();
    },

    showRankingGlobal: () => {
        const d = Storage.get(); const l = $('#ranking-list'); l.innerHTML = '';
        if(Object.keys(d).length === 0) l.innerHTML = '<p style="color:#aaa;text-align:center">Sin r√©cords.</p>';
        else {
            App.list.forEach(g => {
                let html = '';
                ['easy','medium','hard','extreme'].forEach(lvl => {
                    const k = `${g.id}_${lvl}`;
                    if(d[k]) {
                        let val = '';
                        if(g.mode === 'score') {
                            val = `${d[k].score} pts`;
                            if(g.id === 'chp') val = `Nivel ${d[k].score}`;
                        } else {
                            const m = Math.floor(d[k].score/60).toString().padStart(2,'0');
                            const s = (d[k].score%60).toString().padStart(2,'0');
                            val = `${m}:${s}`;
                        }
                        html += `<li><span>${lvl.toUpperCase()}</span> <b>${d[k].name} (${val})</b></li>`;
                    }
                });
                if(html) l.innerHTML += `<h3 style="color:var(--primary);margin-top:15px;font-size:1rem">${g.i} ${g.t}</h3><ul>${html}</ul>`;
            });
        }
        $('#modal-ranking').classList.add('active');
    }
};

window.onload = App.init;
</script>
</body>
</html>
